{"version":3,"sources":["../../lib/repl-kit/index.ts","../../lib/repl-kit/term.ts","../../lib/repl-kit/ui.ts","../../lib/repl-kit/errors.ts","../../lib/repl-kit/history.ts","../../lib/repl-kit/key-bindings.ts"],"sourcesContent":["import { lineKeyBinder } from \"./key-bindings\";\nimport { Runnable } from \"./runnable\";\n\nexport class Repl {\n  constructor(readonly lang: Runnable) {}\n\n  spashScreen() {\n    console.log(\"help: ?⏎\");\n    console.log(\"exit: CTRL-d\");\n  }\n\n  async run() {\n    process.stdin.setRawMode(true);\n    process.stdin.setEncoding(\"utf8\");\n    this.spashScreen();\n    process.stdin.resume();\n\n    return new Promise((resolve) => {\n      let apply = lineKeyBinder(this.lang, () => {\n        process.stdin.destroy();\n        resolve(undefined);\n      });\n      process.stdin.on(\"data\", (key) => {\n        apply(key);\n        process.stdin.resume();\n      });\n    });\n  }\n}\n","export const TERM = {\n  hideCursor: \"\\u001B[?25l\",\n  showCursor: \"\\u001B[?25h\",\n  ctrlA: \"\\x01\",\n  ctrlC: \"\\x03\",\n  ctrlD: \"\\x04\",\n  ctrlE: \"\\x05\",\n  ctrlK: \"\\x0B\",\n  up: \"\\x1B[A\",\n  down: \"\\x1B[B\",\n  right: \"\\x1B[C\",\n  left: \"\\x1B[D\",\n  backspace: \"\\x7F\",\n  delete: \"\\x1B[3~\",\n  newline: \"\\n\",\n  return: \"\\r\",\n\n  reset: \"\\x1b[0m\",\n  bright: \"\\x1b[1m\",\n  dim: \"\\x1b[2m\",\n  underscore: \"\\x1b[4m\",\n  blink: \"\\x1b[5m\",\n  reverse: \"\\x1b[7m\",\n  hidden: \"\\x1b[8m\",\n\n  fgBlack: \"\\x1b[30m\",\n  fgRed: \"\\x1b[31m\",\n  fgGreen: \"\\x1b[32m\",\n  fgYellow: \"\\x1b[33m\",\n  fgBlue: \"\\x1b[34m\",\n  fgMagenta: \"\\x1b[35m\",\n  fgCyan: \"\\x1b[36m\",\n  fgWhite: \"\\x1b[37m\",\n\n  bgBlack: \"\\x1b[40m\",\n  bgRed: \"\\x1b[41m\",\n  bgGreen: \"\\x1b[42m\",\n  bgYellow: \"\\x1b[43m\",\n  bgBlue: \"\\x1b[44m\",\n  bgMagenta: \"\\x1b[45m\",\n  bgCyan: \"\\x1b[46m\",\n  bgWhite: \"\\x1b[47m\",\n};\n\nexport const isPrintable = (key: string) =>\n  !key.match(/[\\p{Cc}\\p{Cn}\\p{Cs}]+/gu);\n\nexport const isUnprintable = (key: string) => !isPrintable(key);\n","import { TERM } from \"./term\";\n\nclass Prompt {\n  constructor(readonly isError: boolean, readonly isContinuation: boolean) {}\n  get text() {\n    if (this.isError) return \"× \";\n    if (this.isContinuation) return \"  \";\n    return \"» \";\n  }\n  get markup() {\n    if (this.isError) return `${TERM.fgRed}${this.text}${TERM.reset}`;\n    return `${TERM.dim}${this.text}${TERM.reset}`;\n  }\n  get width() {\n    return 2;\n  }\n}\n\nclass Input {\n  private _text = \"\";\n  insert(text: string, at: number) {\n    const [front, back] = [\n      this._text.substring(0, at),\n      this._text.substring(at),\n    ];\n    this._text = `${front}${text}${back}`;\n  }\n  backspace(at: number) {\n    const [front, back] = [\n      this._text.substring(0, at),\n      this._text.substring(at),\n    ];\n    const chomp = front.substring(0, front.length - 1);\n    this._text = `${chomp}${back}`;\n  }\n  clear(at: number) {\n    this._text = this._text.substring(0, at);\n  }\n  get text() {\n    return this._text;\n  }\n}\n\nexport class Line {\n  readonly input: Input;\n  readonly prompt: Prompt;\n  private cursor = 0;\n  constructor(isError: boolean, isContinuation: boolean) {\n    this.prompt = new Prompt(isError, isContinuation);\n    this.input = new Input();\n  }\n  render() {\n    this.cursor = 0;\n    process.stdout.moveCursor(this.cursor, 1);\n    process.stdout.cursorTo(this.cursor);\n    process.stdout.write(this.prompt.markup);\n    process.stdout.write(this.input.text);\n  }\n  clearTilEnd() {\n    this.input.clear(this.cursor);\n    process.stdout.clearScreenDown();\n  }\n  insert(text: string) {\n    this.input.insert(text, this.cursor);\n    process.stdout.clearLine(1);\n    const appended = this.input.text.substring(this.cursor);\n    process.stdout.write(appended);\n    this.cursor += text.length;\n    process.stdout.moveCursor(-(appended.length - text.length), 0);\n  }\n  backspace() {\n    if (this.cursor === 0) return;\n    this.input.backspace(this.cursor);\n    this.cursor -= 1;\n    process.stdout.moveCursor(-1, 0);\n    process.stdout.clearLine(1);\n    const remaining = this.input.text.substring(this.cursor);\n    process.stdout.write(remaining);\n    process.stdout.moveCursor(-remaining.length, 0);\n  }\n  moveRight(n = 1) {\n    if (this.cursor === this.input.text.length) return;\n    this.cursor += n;\n    process.stdout.moveCursor(n, 0);\n  }\n  moveLeft(n = 1) {\n    if (this.cursor === 0) return;\n    this.cursor -= n;\n    process.stdout.moveCursor(-n, 0);\n  }\n  moveToLineStart() {\n    this.moveLeft(this.cursor);\n  }\n  moveToLineEnd() {\n    this.moveRight(this.input.text.length - this.cursor);\n  }\n  newline() {\n    process.stdout.moveCursor(0, 1);\n    process.stdout.cursorTo(0);\n    console.log(\"\");\n  }\n  hideCursor() {\n    process.stdout.write(TERM.hideCursor);\n  }\n  showCursor() {\n    process.stdout.write(TERM.showCursor);\n  }\n}\n","export class IncompleteException {}\nexport class InvalidException {}\n","class History {\n  private commands = [\"\"];\n  private pos = 0;\n  update(command: string) {\n    this.commands[this.pos] = command;\n  }\n  save() {\n    this.commands.push(\"\");\n    this.pos += 1;\n  }\n  next() {\n    return this.goto(this.pos + 1);\n  }\n  previous() {\n    return this.goto(this.pos - 1);\n  }\n  private goto(n: number) {\n    this.pos = Math.max(0, n);\n    this.pos = Math.min(this.commands.length - 1, this.pos);\n    return this.commands[this.pos];\n  }\n}\n\nexport const history = new History();\n","import { Line } from \"./ui\";\nimport { isPrintable, TERM } from \"./term\";\nimport { IncompleteException } from \"./errors\";\nimport { Runnable } from \"./runnable\";\nimport { history } from \"./history\";\n\nexport function lineKeyBinder(lang: Runnable, exit: () => void) {\n  let multiLineBuffer: string[] = [];\n  let line = new Line(false, false);\n  line.render();\n  return (key: Buffer): void => {\n    const code = key.toString();\n    const inserter = () => {\n      if (isPrintable(code)) line.insert(code);\n      else {\n        // unhandled, uncomment for debugging\n        // console.log({ key: code });\n      }\n    };\n    const runner = () => {\n      if (line.input.text || line.prompt.isContinuation) {\n        try {\n          let command = line.input.text;\n          if (line.prompt.isContinuation)\n            command = [...multiLineBuffer, command].join(\"\\n\");\n          lang.run(command);\n          line = new Line(false, false);\n          history.save();\n          multiLineBuffer = [];\n        } catch (e) {\n          if (e instanceof IncompleteException) {\n            multiLineBuffer.push(line.input.text);\n            line = new Line(line.prompt.isError, true);\n          } else {\n            line = new Line(true, line.prompt.isContinuation);\n          }\n        }\n      } else {\n        line = new Line(false, false);\n      }\n      return line;\n    };\n    const map = {\n      [TERM.ctrlA]: () => line.moveToLineStart(),\n      [TERM.ctrlC]: () => {\n        line.newline();\n        line.moveToLineStart();\n        line.clearTilEnd();\n        line.render();\n      },\n      [TERM.ctrlD]: () => exit(),\n      [TERM.ctrlE]: () => line.moveToLineEnd(),\n      [TERM.ctrlK]: () => line.clearTilEnd(),\n      [TERM.up]: () => {\n        line.moveToLineStart();\n        line.clearTilEnd();\n        line.insert(history.previous());\n      },\n      [TERM.down]: () => {\n        line.moveToLineStart();\n        line.clearTilEnd();\n        line.insert(history.next());\n      },\n      [TERM.right]: () => line.moveRight(),\n      [TERM.left]: () => line.moveLeft(),\n      [TERM.backspace]: () => line.backspace(),\n      [TERM.return]: () => {\n        line.newline();\n        runner();\n        line.render();\n      },\n      [TERM.delete]: () => {\n        line.moveRight();\n        line.backspace();\n      },\n    };\n\n    line.hideCursor();\n    if (map[code]) map[code]();\n    else inserter();\n    line.showCursor();\n    history.update(line.input.text.trim());\n  };\n}\n"],"mappings":"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","names":[]}