{"version":3,"sources":["../../lib/repl-kit/index.ts","../../lib/repl-kit/term.ts","../../lib/repl-kit/ui.ts","../../lib/repl-kit/errors.ts","../../lib/repl-kit/history.ts","../../lib/repl-kit/key-bindings.ts"],"sourcesContent":["import { lineKeyBinder } from \"./key-bindings\";\nimport { Runnable } from \"./runnable\";\n\nexport class Repl {\n  constructor(readonly lang: Runnable) {}\n\n  spashScreen() {\n    console.log(\"help: ?⏎\");\n    console.log(\"exit: CTRL-d\");\n  }\n\n  async run() {\n    process.stdin.setRawMode(true);\n    process.stdin.setEncoding(\"utf8\");\n    this.spashScreen();\n    process.stdin.resume();\n\n    return new Promise((resolve) => {\n      let apply = lineKeyBinder(this.lang, () => {\n        process.stdin.destroy();\n        resolve(undefined);\n      });\n      process.stdin.on(\"data\", (key) => {\n        apply(key);\n        process.stdin.resume();\n      });\n    });\n  }\n}\n","export const TERM = {\n  hideCursor: \"\\u001B[?25l\",\n  showCursor: \"\\u001B[?25h\",\n  ctrlA: \"\\x01\",\n  ctrlC: \"\\x03\",\n  ctrlD: \"\\x04\",\n  ctrlE: \"\\x05\",\n  ctrlK: \"\\x0B\",\n  up: \"\\x1B[A\",\n  down: \"\\x1B[B\",\n  right: \"\\x1B[C\",\n  left: \"\\x1B[D\",\n  backspace: \"\\x7F\",\n  delete: \"\\x1B[3~\",\n  newline: \"\\n\",\n  return: \"\\r\",\n\n  reset: \"\\x1b[0m\",\n  bright: \"\\x1b[1m\",\n  dim: \"\\x1b[2m\",\n  underscore: \"\\x1b[4m\",\n  blink: \"\\x1b[5m\",\n  reverse: \"\\x1b[7m\",\n  hidden: \"\\x1b[8m\",\n\n  fgBlack: \"\\x1b[30m\",\n  fgRed: \"\\x1b[31m\",\n  fgGreen: \"\\x1b[32m\",\n  fgYellow: \"\\x1b[33m\",\n  fgBlue: \"\\x1b[34m\",\n  fgMagenta: \"\\x1b[35m\",\n  fgCyan: \"\\x1b[36m\",\n  fgWhite: \"\\x1b[37m\",\n\n  bgBlack: \"\\x1b[40m\",\n  bgRed: \"\\x1b[41m\",\n  bgGreen: \"\\x1b[42m\",\n  bgYellow: \"\\x1b[43m\",\n  bgBlue: \"\\x1b[44m\",\n  bgMagenta: \"\\x1b[45m\",\n  bgCyan: \"\\x1b[46m\",\n  bgWhite: \"\\x1b[47m\",\n};\n\nexport const isPrintable = (key: string) =>\n  !key.match(/[\\p{Cc}\\p{Cn}\\p{Cs}]+/gu);\n\nexport const isUnprintable = (key: string) => !isPrintable(key);\n","import { TERM } from \"./term\";\n\nclass Prompt {\n  constructor(readonly isError: boolean, readonly isContinuation: boolean) {}\n  get text() {\n    if (this.isError) return \"× \";\n    if (this.isContinuation) return \"  \";\n    return \"» \";\n  }\n  get markup() {\n    if (this.isError) return `${TERM.fgRed}${this.text}${TERM.reset}`;\n    return `${TERM.dim}${this.text}${TERM.reset}`;\n  }\n  get width() {\n    return 2;\n  }\n}\n\nclass Input {\n  private _text = \"\";\n  insert(text: string, at: number) {\n    const [front, back] = [\n      this._text.substring(0, at),\n      this._text.substring(at),\n    ];\n    this._text = `${front}${text}${back}`;\n  }\n  backspace(at: number) {\n    const [front, back] = [\n      this._text.substring(0, at),\n      this._text.substring(at),\n    ];\n    const chomp = front.substring(0, front.length - 1);\n    this._text = `${chomp}${back}`;\n  }\n  clear(at: number) {\n    this._text = this._text.substring(0, at);\n  }\n  get text() {\n    return this._text;\n  }\n}\n\nexport class Line {\n  readonly input: Input;\n  readonly prompt: Prompt;\n  private cursor = 0;\n  constructor(isError: boolean, isContinuation: boolean) {\n    this.prompt = new Prompt(isError, isContinuation);\n    this.input = new Input();\n  }\n  render() {\n    this.cursor = 0;\n    process.stdout.moveCursor(this.cursor, 1);\n    process.stdout.cursorTo(this.cursor);\n    process.stdout.write(this.prompt.markup);\n    process.stdout.write(this.input.text);\n  }\n  clearTilEnd() {\n    this.input.clear(this.cursor);\n    process.stdout.clearScreenDown();\n  }\n  insert(text: string) {\n    this.input.insert(text, this.cursor);\n    process.stdout.clearLine(1);\n    const appended = this.input.text.substring(this.cursor);\n    process.stdout.write(appended);\n    this.cursor += text.length;\n    process.stdout.moveCursor(-(appended.length - text.length), 0);\n  }\n  backspace() {\n    if (this.cursor === 0) return;\n    this.input.backspace(this.cursor);\n    this.cursor -= 1;\n    process.stdout.moveCursor(-1, 0);\n    process.stdout.clearLine(1);\n    const remaining = this.input.text.substring(this.cursor);\n    process.stdout.write(remaining);\n    process.stdout.moveCursor(-remaining.length, 0);\n  }\n  moveRight(n = 1) {\n    if (this.cursor === this.input.text.length) return;\n    this.cursor += n;\n    process.stdout.moveCursor(n, 0);\n  }\n  moveLeft(n = 1) {\n    if (this.cursor === 0) return;\n    this.cursor -= n;\n    process.stdout.moveCursor(-n, 0);\n  }\n  moveToLineStart() {\n    this.moveLeft(this.cursor);\n  }\n  moveToLineEnd() {\n    this.moveRight(this.input.text.length - this.cursor);\n  }\n  newline() {\n    process.stdout.moveCursor(0, 1);\n    process.stdout.cursorTo(0);\n    console.log(\"\");\n  }\n  hideCursor() {\n    process.stdout.write(TERM.hideCursor);\n  }\n  showCursor() {\n    process.stdout.write(TERM.showCursor);\n  }\n}\n","export class IncompleteException {}\nexport class InvalidException {}\n","class History {\n  private commands = [\"\"];\n  private pos = 0;\n  update(command: string) {\n    this.commands[this.pos] = command;\n  }\n  save() {\n    this.commands.push(\"\");\n    this.pos += 1;\n  }\n  next() {\n    return this.goto(this.pos + 1);\n  }\n  previous() {\n    return this.goto(this.pos - 1);\n  }\n  private goto(n: number) {\n    this.pos = Math.max(0, n);\n    this.pos = Math.min(this.commands.length - 1, this.pos);\n    return this.commands[this.pos];\n  }\n}\n\nexport const history = new History();\n","import { Line } from \"./ui\";\nimport { isPrintable, TERM } from \"./term\";\nimport { IncompleteException } from \"./errors\";\nimport { Runnable } from \"./runnable\";\nimport { history } from \"./history\";\n\nexport function lineKeyBinder(lang: Runnable, exit: () => void) {\n  let multiLineBuffer: string[] = [];\n  let line = new Line(false, false);\n  line.render();\n  return (key: Buffer): void => {\n    const code = key.toString();\n    const inserter = () => {\n      if (isPrintable(code)) line.insert(code);\n      else {\n        // unhandled, uncomment for debugging\n        // console.log({ key: code });\n      }\n    };\n    const runner = () => {\n      if (line.input.text || line.prompt.isContinuation) {\n        try {\n          let command = line.input.text;\n          if (line.prompt.isContinuation)\n            command = [...multiLineBuffer, command].join(\"\\n\");\n          lang.run(command);\n          line = new Line(false, false);\n          history.save();\n          multiLineBuffer = [];\n        } catch (e) {\n          if (e instanceof IncompleteException) {\n            multiLineBuffer.push(line.input.text);\n            line = new Line(line.prompt.isError, true);\n          } else {\n            line = new Line(true, line.prompt.isContinuation);\n          }\n        }\n      } else {\n        line = new Line(false, false);\n      }\n      return line;\n    };\n    const map = {\n      [TERM.ctrlA]: () => line.moveToLineStart(),\n      [TERM.ctrlC]: () => {\n        line.newline();\n        line.moveToLineStart();\n        line.clearTilEnd();\n        line.render();\n      },\n      [TERM.ctrlD]: () => exit(),\n      [TERM.ctrlE]: () => line.moveToLineEnd(),\n      [TERM.ctrlK]: () => line.clearTilEnd(),\n      [TERM.up]: () => {\n        line.moveToLineStart();\n        line.clearTilEnd();\n        line.insert(history.previous());\n      },\n      [TERM.down]: () => {\n        line.moveToLineStart();\n        line.clearTilEnd();\n        line.insert(history.next());\n      },\n      [TERM.right]: () => line.moveRight(),\n      [TERM.left]: () => line.moveLeft(),\n      [TERM.backspace]: () => line.backspace(),\n      [TERM.return]: () => {\n        line.newline();\n        runner();\n        line.render();\n      },\n      [TERM.delete]: () => {\n        line.moveRight();\n        line.backspace();\n      },\n    };\n\n    line.hideCursor();\n    if (map[code]) map[code]();\n    else inserter();\n    line.showCursor();\n    history.update(line.input.text.trim());\n  };\n}\n"],"mappings":"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","names":["repl_kit_exports","__export","Repl","__toCommonJS","TERM","isPrintable","__name","key","Prompt","isError","isContinuation","TERM","__name","Input","text","at","front","back","chomp","Line","appended","remaining","n","IncompleteException","__name","History","command","n","__name","history","lineKeyBinder","lang","exit","multiLineBuffer","line","Line","key","code","inserter","__name","isPrintable","runner","command","history","e","IncompleteException","map","TERM","Repl","lang","__async","resolve","apply","lineKeyBinder","key","__name"]}