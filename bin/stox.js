"use strict";var qt=Object.create;var Ct=Object.defineProperty;var zt=Object.getOwnPropertyDescriptor;var Kt=Object.getOwnPropertyNames;var Jt=Object.getPrototypeOf,Yt=Object.prototype.hasOwnProperty;var a=(n,r)=>Ct(n,"name",{value:r,configurable:!0});var Xt=(n,r)=>()=>(r||n((r={exports:{}}).exports,r),r.exports);var Zt=(n,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Kt(r))!Yt.call(n,s)&&s!==t&&Ct(n,s,{get:()=>r[s],enumerable:!(e=zt(r,s))||e.enumerable});return n};var Bt=(n,r,t)=>(t=n!=null?qt(Jt(n)):{},Zt(r||!n||!n.__esModule?Ct(t,"default",{value:n,enumerable:!0}):t,n));var Pt=Xt(S=>{var A=console.log,y={},Ft={},Mt=[],B=[],d={opts:[],args:[]};S.version="2.0.2";S.add=function(n,r){for(var t=0;t<n.length;t++)n[t].namespace=r,d.opts.push(n[t])};S.parse=function(n,r,t){if(r===!0)t=!0,r=[];else if(!r)r=[];else for(var e=0;e<r.length;e++)d.args.push(r[e]);t&&n.push({long:"help",description:"Show this help message",callback:S.help});for(var e=0;e<n.length;e++)d.opts.unshift(n[e]);n=d.opts;for(var s=a(function(h,x){var l=x=="short"?"-":"--",v=h[x];if(!i[l+v])i[l+v]=h;else if(h.namespace&&!i[l+h.namespace+"."+v]){i[l+h.namespace+"."+v]=h;for(var $=0;$<d.opts.length;$++){var Z=d.opts[$];Z.namespace==h.namespace&&(x=="long"&&Z.long==h.long?d.opts[$].long=h.namespace+"."+h.long:x=="short"&&delete d.opts[$].short)}}else A("Conflicting flags: "+l+v+`
`),A(Ut()),process.exit(1)},"checkDup"),i={},e=0;e<n.length;e++)n[e].short&&s(n[e],"short"),n[e].long&&s(n[e],"long");for(var e=2;e<process.argv.length;e++){var c=process.argv[e];if(i[c]){var p=i[c];if(!p.value)p.callback&&p.callback(!0),p.short&&(y[p.short]=!0),p.long&&(y[p.long]=!0);else{var u=process.argv[e+1];if(!u||i[u]){var g=p.short||p.long;B.push("Missing value for option: "+g),p.short&&(y[p.short]=!0),p.long&&(y[p.long]=!0)}else p.callback&&p.callback(u),p.short&&(y[p.short]=u),p.long&&(y[p.long]=u),e++}}else if(c[0]=="-")A("Unknown option: "+c),i["--help"]&&A("Try --help"),process.exit(1);else{Mt.push(c);var T=r.shift();T&&(Ft[T.name]=c,T.callback&&T.callback(c))}}for(var e=0;e<n.length;e++){var g=n[e].short||n[e].long;n[e].required&&!S.get(g)&&B.push("Missing required option: "+g)}for(var e=0;e<r.length;e++)r[e].required&&!Ft[r[e].name]&&B.push("Missing required argument: "+r[e].name);if(B.length){for(var e=0;e<B.length;e++)A(B[e]);A(`
`+Ut()),process.exit(1)}};S.get=function(n){return y[n]||y["-"+n]||y["--"+n]};S.values=function(){return Object.keys(y).reduce(function(n,r){return r=r.replace("/^-+/",""),n[r]=S.get(r),n},{})};S.args=function(){return Mt};S.arg=function(n){return Ft[n]};S.help=function(){A(Ut()),process.exit(0)};var Ut=a(function(){var n=process.argv[0].split(require("path").sep).pop(),r=process.argv[1].replace(process.cwd(),"."),t="Usage: "+n+" "+r;if(d.opts.length&&(t+=" [options]"),d.args.length)for(var e=0;e<d.args.length;e++)d.args[e].required?t+=" "+d.args[e].name:t+=" ["+d.args[e].name+"]";t+=`
`;for(var e=0;e<d.opts.length;e++){var s=d.opts[e];s.description&&(t+=s.description+`
`);var i="";s.short&&!s.long?i+="-"+s.short:s.long&&!s.short?i+="--"+s.long:i+="-"+s.short+", --"+s.long,s.value&&(i+=" <value>"),s.required&&(i+=" (required)"),t+="    "+i+`
`}return t},"helpString")});var Wt=Bt(require("fs")),O=Bt(Pt());var tt=class{constructor(r=new D){this.reporter=r;this.opts={stage:"eval"};this.errored=!1}get interpreter(){return this._interpreter||(this._interpreter=new this.Interpreter(this.reporter)),this._interpreter}get resolver(){return this._resolver||(this._resolver=new this.Resolver(this.reporter,this.interpreter)),this._resolver}options(r){this.opts=r}run(r,t){this.errored=!1,this.reporter.pushSource(r,t),this.runToStage(t),this.reporter.popSource()}runToStage(r){let t=new this.Tokenizer(r,this.reporter),e=t.drain();if(this.reporter.errors&&(this.errored=!0,this.reporter.tokenError()),this.opts.stage==="scan"){t.print(e);return}let s=new this.Parser(e,this.reporter),i=s.parse();if(this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(!!i){if(this.resolver.visit(i),this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(this.opts.stage=="parse"){s.print(i);return}this.errored||(this.interpreter.visit(i),this.reporter.errors&&(this.errored=!0,this.reporter.runtimeError()))}}};a(tt,"Language");var Gt="__stoa__::error",P=class{constructor(r,t,e){this.name=r;this.text=t;this.pos=e}toString(){let r=`[${this.pos.line},${this.pos.column}]`;return`${this.name}${r}`}};a(P,"Token");var k=class{constructor(r,t,e,s=1,i=1){this.reporter=e;this.buffer=[];this.eof=!1;this.generator=te(r,t,e,s,i)}take(){return this.peek(),this.buffer.shift()}peek(){return this.buffer.length||this.buffer.push(this.next()),this.buffer[0]}drain(){let r,t=[];for(;r=this.take();)t.push(r);return t}print(r=this.buffer,t="log"){console[t](r.map(e=>`${e}`).join(`
`))}next(){for(;;){if(this.eof)return;let r=this.generator.next().value;if(!r){this.eof=!0;continue}if(r.name==Gt){this.reporter.error(r,"Unrecognized input");continue}if(!r.name.toString().startsWith("_"))return r}}};a(k,"TokenStream");function*te(n,r,t,e,s){let i=0,c=e,p=s;for(;i<n.length;){let[h=Gt,x=n[i]]=g(T()),l=new P(h,x,u()),v=x.split(`
`).length;v>1?(c+=v-1,p=x.length-x.lastIndexOf(`
`)):p+=x.length,i+=x.length,yield l}function u(){return{line:c,column:p}}a(u,"pos");function g(h){return h.length?h.length==1?h[0]:h.reduce((x,l)=>l[1].length>x[1].length||l[1].length==x[1].length&&!l[2]&&x[2]?l:x):[]}a(g,"longest");function T(){let h=[];return Object.entries(r).map(([x,l])=>{if(typeof l=="function"){let v=l(n.substring(i),t,c,p);v!==void 0&&h.push([x,v,!1])}else if(typeof l!="string"){let v=l.source[l.source.length-1]=="*",Z=new RegExp(`^${l.source}`,l.flags).exec(n.substring(i));if(Z)return h.push([x,Z[0],v])}else if(n.substring(i,i+l.length)==l)return h.push([x,l,!1])}),h}a(T,"possible")}a(te,"tokenGenerator");var G={STRINGS:{STD:re},COMMENTS:{SHEBANG:/\#\!\/usr\/bin\/env\s.*/,DOUBLE_SLASH:/\/\/.*/,C_STYLE:ee},SPACE:{ALL:/\s+/}};function ee(n,r,t,e){let s=new k(n,{OPEN:"/*",CLOSE:"*/",ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&i.name=="OPEN"){let c=0,p,u=i.text;for(;p=s.take();)if(u+=p.text,p.name=="OPEN")c+=1;else if(p.name=="CLOSE")if(c)c-=1;else return u;return r.error(i,"Unclosed comment"),u}}a(ee,"cStyleCommentScanner");function re(n,r,t,e){let s=new k(n,{SINGLE:"'",DOUBLE:'"',ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&["SINGLE","DOUBLE"].includes(i.name)){let{text:c}=i,p;for(;p=s.take();)if(c+=p.text,p.name==i.name)return c;return r.error(i,`Unclosed string, expected ${i.text}`),c}}a(re,"stringScanner");var et=class{constructor(r,t){this.tokens=r;this.reporter=t;this.current=0}parse(){}print(r,t="log"){console[t](`${r??""}`)}match(...r){for(let t of r)if(this.check(t))return this.advance(),!0;return!1}consume(r,t){if(this.check(r))return this.advance();throw this.error(t)}error(r,t){let e=t||this.peek()||this.previous(),s=new kt(r);if(!this.peek()){let i=e.text.split(`
`),c=i.length-1,p=e.pos.line+c,u=c?i[i.length-1].length+1:e.pos.column+e.text.length;e=new P("<EOF>","",{line:p,column:u}),s=new wt(r)}return this.reporter.error(e,r),s}check(r){var t;return((t=this.peek())==null?void 0:t.name)==r}atEnd(){var r;return!((r=this.peek())!=null&&r.name)}advance(){return this.atEnd()||this.current++,this.previous()}peek(r=1){return this.tokens[this.current+(r-1)]}previous(){return this.tokens[this.current-1]}};a(et,"Parser");var rt=class{constructor(r=new D,t){this.reporter=r;this.interpreter=t}visit(r){let t=r.constructor.name,e=this[t];if(typeof e=="function")return e.bind(this)(r);throw new Error(`Unvisitable node: ${t} (UNIMPLEMENTED BY AUTHOR)`)}};a(rt,"Visitor");var C=class extends Error{};a(C,"ParseError");var kt=class extends C{};a(kt,"InvalidParseTree");var wt=class extends C{};a(wt,"IncompleteParseTree");var D=class{constructor(){this.files=[];this._errors=[]}pushSource(r,t){this.files.push([r,t])}popSource(){this.files.pop()}error(r,t){this._errors.push([r,t])}get errors(){return this._errors.length?this._errors:!1}tokenError(){this.reportErrors("Syntax")}parseError(){this.reportErrors("Parse")}runtimeError(){this.reportErrors("Runtime")}reportErrors(r){let[t,e]=this.files[this.files.length-1],s=e.split(`
`);for(let[i,c]of this._errors){this.log(`${r} error in ${t} at line,col ${i.pos.line},${i.pos.column}`);let p=`${i.pos.line}. `,u=`${s[i.pos.line-1]}`;this.log(`${p}${u}`);let T=`${p}${u}`.replace(/./g," ").substring(0,p.length+i.pos.column-1);this.log(`${T}\u2191`),this.log(`${c}`)}this._errors=[]}log(r){console.error(r)}};a(D,"StdErrReporter");var f=class extends Error{constructor(t,e){super(e);this.token=t}};a(f,"RuntimeError");var Vt="2022.08.15";var _t=class extends k{constructor(r,t){super(r,_t.lexicon,t)}},F=_t;a(F,"Tokenizer"),F.lexicon={FALSE:/false/i,NIL:/nil/,NUMBER:/\d+(\.\d+)?/,STRING:G.STRINGS.STD,TRUE:/true/i,IDENTIFIER:/[a-z][a-z\d]*/i,AND:/and/i,BANG:"!",BANG_EQUAL:"!=",DASH:"-",EQUAL:"=",EQUAL_EQUAL:"==",GREATER:">",GREATER_EQUAL:">=",LESS:"<",LESS_EQUAL:"<=",NOT:/not/i,OR:/or/i,PLUS:"+",SLASH:"/",STAR:"*",COLON:":",COMMA:",",DOT:".",LEFT_CURL:"{",LEFT_PAREN:"(",QUESTION:"?",RIGHT_CURL:"}",RIGHT_PAREN:")",SEMICOLON:";",BREAK:/break/i,CLASS:/class/i,CONTINUE:/continue/i,ELSE:/else/i,FOR:/for/i,FUN:/fun/i,IF:/if/i,PRINT:/print/i,RETURN:/return/i,SUPER:/super/i,THIS:/this/i,VAR:/var/i,WHILE:/while/i,_SHEBANG_COMMENT:G.COMMENTS.SHEBANG,_MULTI_LINE_COMMENT:G.COMMENTS.C_STYLE,_SINGLE_LINE_COMMENT:G.COMMENTS.DOUBLE_SLASH,_SPACE:G.SPACE.ALL};var o=Object.keys(F.lexicon).reduce((n,r)=>(n[r]=r,n),{});var b=class extends rt{};a(b,"Visitor");var st=class{constructor(r,t){this.name=r;this.value=t}};a(st,"AssignExpr");var R=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};a(R,"BinaryExpr");var nt=class{constructor(r,t,e){this.callee=r;this.args=t;this.end=e}};a(nt,"CallExpr");var it=class{constructor(r,t){this.params=r;this.block=t}};a(it,"FunctionExpr");var ot=class{constructor(r){this.inner=r}};a(ot,"GroupExpr");var m=class{constructor(r){this.value=r}toString(){if(this.value===!0||this.value===!1)return`${this.value}`;if(this.value===void 0)return"nil";if(typeof this.value=="string")return this.value;let[r,t]=this.value;return`${r.toFixed(t)}`}};a(m,"LiteralExpr");var V=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};a(V,"LogicalExpr");var at=class{constructor(r,t,e,s,i){this.left=r;this.op1=t;this.middle=e;this.op2=s;this.right=i}};a(at,"TernaryExpr");var pt=class{constructor(r,t){this.operator=r;this.operand=t}};a(pt,"UnaryExpr");var H=class{constructor(r){this.name=r}};a(H,"VariableExpr");var j=class extends b{AssignExpr(r){return`(= ${r.name.text} ${this.visit(r.value)})`}BinaryExpr(r){let t=r.operator.text,e=this.visit(r.left),s=this.visit(r.right);return`(${t} ${e} ${s})`}BlockStmt(r){let t=r.statements.map(e=>this.visit(e)).join(`
`);return`(block 
${Q(t)}
)`}CallExpr(r){let t=`(call ${this.visit(r.callee)}`;if(!r.args.length)return`${t})`;let e=r.args.map(s=>this.visit(s)).join(" ");return`${t} ${e})`}ClassDecl(r){let t=r.funcs.map(e=>this.visit(e)).join(`
`);return`(class ${r.name.text}
${Q(t)}
)`}ExpressionStmt(r){return this.visit(r.expr)}FunctionExpr(r){let t=r.params.map(s=>s.text).join(" "),e=this.visit(r.block);return`(let [${t}] ${e})`}FunctionDecl(r){let t=r.name.text,e=this.visit(r.func);return`(fun ${t} ${e})`}GroupExpr(r){return`(group ${this.visit(r.inner)})`}IfStmt(r){let t=this.visit(r.condition),e=this.visit(r.trueStatement);if(!r.falseStatement)return`(if ${t} ${e})`;let s=this.visit(r.falseStatement);return`(if ${t} 
${Q(e)} 
${Q(s)})`}JumpStmt(r){let t=r.keyword.name,e=this.visit(r.distance||new m([1,0]));return`(${t} ${e})`}LiteralExpr(r){let t=r.toString();return typeof r.value=="string"?JSON.stringify(t):t}LogicalExpr(r){return this.BinaryExpr(r)}PrintStmt(r){return`(print ${this.visit(r.expr)})`}Program(r){let t=r.code.map(e=>this.visit(e)).join(`
`);return`(program 
${Q(t)}
)`}ReturnStmt(r){return`(return ${this.visit(r.expr)})`}TernaryExpr(r){let t=this.visit(r.left),e=this.visit(r.middle),s=this.visit(r.right);return`(?: ${t} ${e} ${s})`}UnaryExpr(r){let t=r.operator.text,e=this.visit(r.operand);return`(${t} ${e})`}VariableDecl(r){let t=`(var ${r.name.text}`,e=r.expr?` ${this.visit(r.expr)}`:"";return`${t}${e})`}VariableExpr(r){return`${r.name.text}`}WhileStmt(r){let t=this.visit(r.condition),e=this.visit(r.body);return`(while ${t} 
${Q(e)}
)`}};a(j,"Printer");function Q(n){let r=new Array(3).fill(" ").join("");return n.replace(/^/mg,r)}a(Q,"indent");var ct=class{constructor(r,t){this.name=r;this.funcs=t}};a(ct,"ClassDecl");var lt=class{constructor(r,t){this.name=r;this.func=t}};a(lt,"FunctionDecl");var ut=class{constructor(r,t){this.name=r;this.expr=t}};a(ut,"VariableDecl");var ht=class{constructor(r){this.code=r}};a(ht,"Program");var U=class{constructor(r){this.statements=r}};a(U,"BlockStmt");var W=class{constructor(r){this.expr=r}};a(W,"ExpressionStmt");var q=class{constructor(r,t,e){this.condition=r;this.trueStatement=t;this.falseStatement=e}};a(q,"IfStmt");var mt=class{constructor(r,t){this.keyword=r;this.distance=t}};a(mt,"JumpStmt");var xt=class{constructor(r){this.expr=r}};a(xt,"PrintStmt");var Et=class{constructor(r,t){this.expr=r;this.keyword=t}};a(Et,"ReturnStmt");var z=class{constructor(r,t){this.condition=r;this.body=t}};a(z,"WhileStmt");var ft=class extends et{parse(){return this._parsed||(this._parsed=this.Program()),this._parsed}toString(){return this._parsed?new j().visit(this._parsed):"un-parsed"}print(t=this._parsed,e="log"){let s=t?new j().visit(t):"()";console[e](s)}Program(){let t=[];for(;!this.atEnd();){let e=this.Declaration();e&&t.push(e)}return new ht(t)}Declaration(){var t,e;try{return((t=this.peek())==null?void 0:t.name)==o.FUN&&((e=this.peek(2))==null?void 0:e.name)==o.IDENTIFIER?(this.match(o.FUN),this.FunDeclaration()):this.match(o.CLASS)?this.ClassDeclaration():this.match(o.VAR)?this.VarDeclaration():this.Statement()}catch(s){if(s instanceof C){this.synchronize();return}else throw s}}ClassDeclaration(){let t=this.consume("IDENTIFIER","Expected identifier");this.consume(o.LEFT_CURL,'Expected "{"');let e=[];for(;;){let s=this.FunDeclaration();if(!s)break;e.push(s)}return this.consume(o.RIGHT_CURL,'Expected "}"'),new ct(t,e)}FunDeclaration(){var t;if(((t=this.peek())==null?void 0:t.name)==o.IDENTIFIER){let e=this.consume("IDENTIFIER","Expected identifier"),s=this.FunctionExpr();return new lt(e,s)}}FunctionExpr(){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Parameters();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Block();if(!e)throw this.error("Expected {");return new it(t,e)}Parameters(){var e,s;let t=[];if(((e=this.peek())==null?void 0:e.name)!=o.RIGHT_PAREN){t.length>=255&&this.error("Too many params (255 max)");do{let i=this.consume(o.IDENTIFIER,"expected param name");t.push(i)}while(((s=this.peek())==null?void 0:s.name)==o.COMMA)}return t}VarDeclaration(){let t=this.consume("IDENTIFIER","Expected identifier"),e;return this.match(o.EQUAL)&&(e=this.Expression()),this.consume(o.SEMICOLON,"Expected ;"),new ut(t,e)}Statement(){return this.PrintStatement()||this.ReturnStatement()||this.IfStatement()||this.WhileStatement()||this.ForStatement()||this.JumpStatement()||this.Block()||this.ExpressionStatement()}ReturnStatement(){if(this.match(o.RETURN)){let t=this.previous(),e=new m(void 0);return this.match(o.SEMICOLON)||(e=this.Expression(),this.consume(o.SEMICOLON,"Expected ;")),new Et(e,t)}}Block(){var t;if(this.match(o.LEFT_CURL)){let e=[];for(;!this.atEnd()&&((t=this.peek())==null?void 0:t.name)!=o.RIGHT_CURL;){let i=this.Declaration();i&&e.push(i)}let s=new U(e);return this.consume(o.RIGHT_CURL,"Expected }"),s}}JumpStatement(){var t;if(this.match(o.BREAK,o.CONTINUE)){let e=this.previous(),s=new m([1,0]);return((t=this.peek())==null?void 0:t.name)!=o.SEMICOLON&&(s=this.Expression()),this.consume(o.SEMICOLON,"Expected ;"),new mt(e,s)}}IfStatement(){if(this.match(o.IF)){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Statement();if(this.match(o.ELSE)){let s=this.Statement();return new q(t,e,s)}else return new q(t,e)}}WhileStatement(){if(this.match(o.WHILE)){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Statement();return new z(t,e)}}ForStatement(){var t,e;if(this.match(o.FOR)){this.consume(o.LEFT_PAREN,"Expected (");let s=this.match(o.VAR)&&this.VarDeclaration()||this.ExpressionStatement()||this.consume(o.SEMICOLON,"Expected ;")&&new m(!0),i=new m(!0);((t=this.peek())==null?void 0:t.name)!=o.SEMICOLON&&(i=this.Expression()),this.consume(o.SEMICOLON,"Expected ;");let c=new m(!0);((e=this.peek())==null?void 0:e.name)!=o.RIGHT_PAREN&&(c=this.Expression()),this.consume(o.RIGHT_PAREN,"Expected )");let p=this.Statement();return new U([s,new z(i,new U([p,new W(c)]))])}}PrintStatement(){if(this.match(o.PRINT)){let t=this.Expression();return this.consume(o.SEMICOLON,"Expected ;"),new xt(t)}}ExpressionStatement(){let t=this.Expression();return this.consume(o.SEMICOLON,"Expected ;"),new W(t)}Expression(){return this.Comma()}Comma(){let t=this.Assignment();for(;this.match(o.COMMA);){let e=this.previous(),s=this.Assignment();t=new R(t,e,s)}return t}Assignment(){let t=this.LogicOr();if(this.match(o.EQUAL)){let e=this.previous(),s=this.Assignment();if(t instanceof H)return new st(t.name,s);this.error("Invalid assignment target",e)}return t}LogicOr(){let t=this.LogicAnd();for(;this.match(o.OR);){let e=this.previous(),s=this.LogicAnd();t=new V(t,e,s)}return t}LogicAnd(){let t=this.Conditional();for(;this.match(o.AND);){let e=this.previous(),s=this.Conditional();t=new V(t,e,s)}return t}Conditional(){let t=this.Equality();for(;this.match(o.QUESTION);){let e=this.previous(),s=this.Equality();this.consume(o.COLON,"Expected :");let i=this.previous(),c=this.Equality();t=new at(t,e,s,i,c)}return t}Equality(){let t=this.Comparison();for(;this.match(o.BANG_EQUAL,o.EQUAL_EQUAL);){let e=this.previous(),s=this.Comparison();t=new R(t,e,s)}return t}Comparison(){let t=this.Term();for(;this.match(o.LESS,o.GREATER,o.LESS_EQUAL,o.GREATER_EQUAL);){let e=this.previous(),s=this.Term();t=new R(t,e,s)}return t}Term(){let t=this.Factor();for(;this.match(o.PLUS,o.DASH);){let e=this.previous(),s=this.Factor();t=new R(t,e,s)}return t}Factor(){let t=this.Unary();for(;this.match(o.STAR,o.SLASH);){let e=this.previous(),s=this.Unary();t=new R(t,e,s)}return t}Unary(){for(;this._InvalidUnary(););return this._ValidUnary()}_InvalidUnary(){if(this.match(o.PLUS,o.STAR,o.SLASH))return this.error("Binary operator is missing the left operand",this.previous()),this.previous(),this.Unary()}_ValidUnary(){if(this.match(o.BANG,o.DASH)){let t=this.previous(),e=this.Unary();return new pt(t,e)}return this.Call()}Call(){let t=this.Primary();if(!this.check(o.LEFT_PAREN))return t;for(;this.match(o.LEFT_PAREN);){let e=[];if(!this.check(o.RIGHT_PAREN)){e.length>=255&&this.error("Too many args (255 max)");do e.push(this.Expression());while(this.match(o.COMMA))}let s=this.consume(o.RIGHT_PAREN,"Expected ) after arguments");t=new nt(t,e,s)}return t}Primary(){if(this.match(o.NUMBER)){let t=this.previous().text,e=parseFloat(t),s=`${t}.`.split(".")[1].length;return new m([e,s])}if(this.match(o.STRING)){let t=this.previous().text,[e,...s]=t.split("");return e===s[s.length-1]&&s.pop(),new m(s.join(""))}if(this.match(o.TRUE))return new m(!0);if(this.match(o.FALSE))return new m(!1);if(this.match(o.NIL))return new m(void 0);if(this.match(o.IDENTIFIER))return new H(this.previous());if(this.match(o.LEFT_PAREN)){let t=this.Expression();return this.consume(o.RIGHT_PAREN,'Expected ")" after expression'),new ot(t)}if(this.match(o.FUN))return this.FunctionExpr();throw this.error("Expected to find an expression")}synchronize(){var t;for(this.advance();!this.atEnd();){if(this.previous().name=="SEMICOLON")return;switch(((t=this.peek())==null?void 0:t.name)??""){case"CLASS":case"FOR":case"FUN":case"IF":case"PRINT":case"RETURN":case"VAR":case"WHILE":return}this.advance()}}};a(ft,"Parser");var dt=class extends b{constructor(t,e){super();this.reporter=t;this.evaluator=e;this.currentFunction=0;this.scopes=[]}beginScope(){this.scopes.unshift({})}endScope(){this.scopes.shift()}declare(t){let e=this.scopes[0];!e||(e[t.text]===0&&this.reporter.error(t,"Variable is already declared"),e[t.text]===1&&this.reporter.error(t,"Variable is already defined"),e[t.text]=0)}define(t){let e=this.scopes[0];!e||(e[t.text]=1)}resolveLocal(t,e){this.scopes.find((s,i)=>s[e.text]?(this.evaluator.resolve(t,i),!0):!1)}resolveFunction(t,e){let s=this.currentFunction;this.currentFunction=e,this.beginScope();for(let i of t.params)this.declare(i),this.define(i);this.visit(t.block),this.endScope(),this.currentFunction=s}AssignExpr(t){this.visit(t.value),this.resolveLocal(t,t.name)}BinaryExpr(t){this.visit(t.left),this.visit(t.right)}BlockStmt(t){this.beginScope();for(let e of t.statements)this.visit(e);this.endScope()}CallExpr(t){this.visit(t.callee);for(let e of t.args)this.visit(e)}ClassDecl(t){this.declare(t.name),this.define(t.name)}ExpressionStmt(t){this.visit(t.expr)}FunctionExpr(t){this.resolveFunction(t,1)}FunctionDecl(t){this.declare(t.name),this.define(t.name),this.resolveFunction(t.func,1)}GroupExpr(t){this.visit(t.inner)}IfStmt(t){this.visit(t.condition),this.visit(t.trueStatement),t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){this.visit(t.distance)}LiteralExpr(t){}LogicalExpr(t){this.visit(t.left),this.visit(t.right)}PrintStmt(t){this.visit(t.expr)}Program(t){for(let e of t.code)this.visit(e)}ReturnStmt(t){this.currentFunction==0&&this.reporter.error(t.keyword,"No return from top-level allowed"),this.visit(t.expr)}TernaryExpr(t){this.visit(t.left),this.visit(t.middle),this.visit(t.right)}UnaryExpr(t){this.visit(t.operand)}VariableDecl(t){this.declare(t.name),t.expr&&this.visit(t.expr),this.define(t.name)}VariableExpr(t){let e=this.scopes[0];!e||(e[t.name.text]===0&&this.reporter.error(t.name,"Reference to uninitialized variable"),this.resolveLocal(t,t.name))}WhileStmt(t){this.visit(t.condition),this.visit(t.body)}};a(dt,"Resolver");var w=class{constructor(r){this.enclosure=r;this.table=new Map}has(r){var t;return this.table.has(r.text)||!!((t=this.enclosure)!=null&&t.has(r))}init(r){this.table.has(r.text)||this.table.set(r.text,void 0)}set(r,t,e=0){var s;if(e>0&&this.enclosure)return this.enclosure.set(r,t,e-1);if(this.table.has(r.text))this.table.set(r.text,t);else if((s=this.enclosure)!=null&&s.has(r))this.enclosure.set(r,t);else throw new f(r,`No such variable: ${r.text}`)}get(r,t=0){var e;if(t>0&&this.enclosure)return this.enclosure.get(r,t-1);if(this.table.has(r.text))return this.table.get(r.text);if((e=this.enclosure)!=null&&e.has(r))return this.enclosure.get(r);throw new f(r,`Undefined variable: ${r.text}`)}};a(w,"Environment");function Ht(n){n.globals.init({text:"clock"}),n.globals.set({text:"clock"},{arity:0,call(){return new Date().toLocaleString()}})}a(Ht,"registerGlobals");function L(n){return Array.isArray(n)&&n.length==2}a(L,"isNumber");function $t(n){return typeof n=="string"}a($t,"isString");function I(n){return!(n===!1||n===void 0)}a(I,"truthy");var K=class{constructor(r=void 0){this.value=r}};a(K,"ReturnException");var _=class{constructor(r=1){this.distance=r}};a(_,"JumpException");var J=class extends _{};a(J,"BreakException");var Y=class extends _{};a(Y,"ContinueException");function X(n){return n?!!n.call:!1}a(X,"isCallable");var gt=class{constructor(r,t){this.arity=r;this.call=t}};a(gt,"Function");var vt=class{constructor(r){this.name=r}toString(){return this.name}};a(vt,"StoxClass");var St=class extends b{constructor(t){super();this.reporter=t;this.globals=new w;this.env=this.globals;this.locals=new Map;Ht(this)}resolve(t,e){this.locals.set(t,e)}lookUpVariable(t,e){let s=this.locals.get(e);return s!==void 0?this.env.get(t,s):this.globals.get(t)}AssignExpr(t){let e=this.visit(t.value),s=this.locals.get(t);return s!==void 0?this.env.set(t.name,e,s):this.globals.set(t.name,e),e}BinaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=this.visit(t.right);if(e==o.COMMA)return i;if(e==o.PLUS&&($t(s)||$t(i))){let c=X(s)?s:new m(s),p=X(i)?i:new m(i);return`${c}${p}`}if(e==o.EQUAL_EQUAL)return L(s)&&L(i)?s[0]==i[0]:s===i;if(e==o.BANG_EQUAL)return L(s)&&L(i)?s[0]!=i[0]:s!==i;if(!L(s)||!L(i))throw new f(t.operator,"number values expected");if(i[0]==0)throw new f(t.operator,"divide by zero");if(e==o.PLUS)return[s[0]+i[0],Math.max(s[1],i[1])];if(e==o.DASH)return[s[0]-i[0],Math.max(s[1],i[1])];if(e==o.STAR)return[s[0]*i[0],Math.max(s[1],i[1])];if(e==o.SLASH)return[s[0]/i[0],Math.max(s[1],i[1])];if(e==o.GREATER)return s[0]>i[0];if(e==o.GREATER_EQUAL)return s[0]>=i[0];if(e==o.LESS)return s[0]<i[0];if(e==o.LESS_EQUAL)return s[0]<=i[0];throw new f(t.operator,"Unexpected binary expression")}BlockStmt(t){let e=this.env;this.env=new w(e);try{t.statements.map(s=>this.visit(s))}finally{this.env=e}}CallExpr(t){let e=this.visit(t.callee);if(!X(e))throw new f(t.end,"uncallable target");if(e.arity!=t.args.length)throw new f(t.end,"wrong number of args");return e.call(t.args.map(s=>this.visit(s)))}ClassDecl(t){this.env.init(t.name);let e=new vt(t.name.text);this.env.set(t.name,e)}ExpressionStmt(t){this.visit(t.expr)}FunctionExpr(t){let e=new w(this.env);return new gt(t.params.length,s=>{let i=this.env;this.env=new w(e);try{s.map((c,p)=>{let u=t.params[p];this.env.init(u),this.env.set(u,c)}),this.visit(t.block)}catch(c){if(c instanceof K)return c.value;throw c}finally{this.env=i}})}FunctionDecl(t){let e=this.FunctionExpr(t.func);this.env.init(t.name),this.env.set(t.name,e)}GroupExpr(t){return this.visit(t.inner)}IfStmt(t){let e=this.visit(t.condition);I(e)?this.visit(t.trueStatement):t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){let e=this.visit(t.distance||new m([1,0]));throw L(e)?t.keyword.name==o.BREAK?new J(e[0]):new Y(e[0]):new f(t.keyword,"expected numerical distance")}LiteralExpr(t){return t.value}LogicalExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=I(s);if(e==o.OR&&i||e==o.AND&&!i)return s;let c=this.visit(t.right);return I(c)?c:I(!1)}PrintStmt(t){let e=this.visit(t.expr),s=X(e)?e:new m(e).toString();console.log(s+"")}Program(t){try{let e=t.code.map(i=>this.visit(i)),s=e[e.length-1];return X(s)?`${s}`:new m(s).toString()}catch(e){e instanceof f?this.reporter.error(e.token,e.message):this.reporter.error(void 0,e.message)}}ReturnStmt(t){let e=this.visit(t.expr);throw new K(e)}TernaryExpr(t){let{op1:{name:e},op2:{name:s}}=t;if(e==o.QUESTION&&s==o.COLON){let i=this.visit(t.left);return I(i)?this.visit(t.middle):this.visit(t.right)}throw new f(e,"Unexpected ternary expression")}UnaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.operand);if(e==o.BANG)return!I(s);if(!L(s))throw new f(e,"must negate a number value");if(e==o.DASH)return[-s[0],s[1]];throw new f(e,"Unexpected unary expression")}VariableDecl(t){this.env.init(t.name);let e=t.expr?this.visit(t.expr):void 0;this.env.set(t.name,e)}VariableExpr(t){return this.lookUpVariable(t.name,t)}WhileStmt(t){for(;I(this.visit(t.condition));)try{this.visit(t.body)}catch(e){if(e instanceof _){if(e.distance>1)throw e.distance-=1,e;if(e instanceof Y)continue;if(e instanceof J)break}}}};a(St,"Interpreter");var yt=class extends tt{constructor(){super(...arguments);this.version=Vt;this.Tokenizer=F;this.Parser=ft;this.Resolver=dt;this.Interpreter=St}};a(yt,"StoxLang");var E={hideCursor:"\x1B[?25l",showCursor:"\x1B[?25h",ctrlA:"",ctrlC:"",ctrlD:"",ctrlE:"",ctrlK:"\v",up:"\x1B[A",down:"\x1B[B",right:"\x1B[C",left:"\x1B[D",backspace:"\x7F",delete:"\x1B[3~",newline:`
`,return:"\r",reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fgBlack:"\x1B[30m",fgRed:"\x1B[31m",fgGreen:"\x1B[32m",fgYellow:"\x1B[33m",fgBlue:"\x1B[34m",fgMagenta:"\x1B[35m",fgCyan:"\x1B[36m",fgWhite:"\x1B[37m",bgBlack:"\x1B[40m",bgRed:"\x1B[41m",bgGreen:"\x1B[42m",bgYellow:"\x1B[43m",bgBlue:"\x1B[44m",bgMagenta:"\x1B[45m",bgCyan:"\x1B[46m",bgWhite:"\x1B[47m"},Qt=a(n=>!n.match(/[\p{Cc}\p{Cn}\p{Cs}]+/gu),"isPrintable");var It=class{constructor(r,t){this.isError=r;this.isContinuation=t}get text(){return this.isError?"\xD7 ":this.isContinuation?"  ":"\xBB "}get markup(){return this.isError?`${E.fgRed}${this.text}${E.reset}`:`${E.dim}${this.text}${E.reset}`}get width(){return 2}};a(It,"Prompt");var At=class{constructor(){this._text=""}insert(r,t){let[e,s]=[this._text.substring(0,t),this._text.substring(t)];this._text=`${e}${r}${s}`}backspace(r){let[t,e]=[this._text.substring(0,r),this._text.substring(r)],s=t.substring(0,t.length-1);this._text=`${s}${e}`}clear(r){this._text=this._text.substring(0,r)}get text(){return this._text}};a(At,"Input");var N=class{constructor(r,t){this.cursor=0;this.prompt=new It(r,t),this.input=new At}render(){this.cursor=0,process.stdout.moveCursor(this.cursor,1),process.stdout.cursorTo(this.cursor),process.stdout.write(this.prompt.markup),process.stdout.write(this.input.text)}clearTilEnd(){this.input.clear(this.cursor),process.stdout.clearScreenDown()}insert(r){this.input.insert(r,this.cursor),process.stdout.clearLine(1);let t=this.input.text.substring(this.cursor);process.stdout.write(t),this.cursor+=r.length,process.stdout.moveCursor(-(t.length-r.length),0)}backspace(){if(this.cursor===0)return;this.input.backspace(this.cursor),this.cursor-=1,process.stdout.moveCursor(-1,0),process.stdout.clearLine(1);let r=this.input.text.substring(this.cursor);process.stdout.write(r),process.stdout.moveCursor(-r.length,0)}moveRight(r=1){this.cursor!==this.input.text.length&&(this.cursor+=r,process.stdout.moveCursor(r,0))}moveLeft(r=1){this.cursor!==0&&(this.cursor-=r,process.stdout.moveCursor(-r,0))}moveToLineStart(){this.moveLeft(this.cursor)}moveToLineEnd(){this.moveRight(this.input.text.length-this.cursor)}newline(){process.stdout.moveCursor(0,1),process.stdout.cursorTo(0),console.log("")}hideCursor(){process.stdout.write(E.hideCursor)}showCursor(){process.stdout.write(E.showCursor)}};a(N,"Line");var bt=class{};a(bt,"IncompleteException");var Dt=class{constructor(){this.commands=[""];this.pos=0}update(r){this.commands[this.pos]=r}save(){this.commands.push(""),this.pos+=1}next(){return this.goto(this.pos+1)}previous(){return this.goto(this.pos-1)}goto(r){return this.pos=Math.max(0,r),this.pos=Math.min(this.commands.length-1,this.pos),this.commands[this.pos]}};a(Dt,"History");var Rt=new Dt;function jt(n,r){let t=[],e=new N(!1,!1);return e.render(),s=>{let i=s.toString(),c=a(()=>{Qt(i)&&e.insert(i)},"inserter"),p=a(()=>{if(e.input.text||e.prompt.isContinuation)try{let g=e.input.text;e.prompt.isContinuation&&(g=[...t,g].join(`
`)),n.run(g),e=new N(!1,!1),Rt.save(),t=[]}catch(g){g instanceof bt?(t.push(e.input.text),e=new N(e.prompt.isError,!0)):e=new N(!0,e.prompt.isContinuation)}else e=new N(!1,!1);return e},"runner"),u={[E.ctrlA]:()=>e.moveToLineStart(),[E.ctrlC]:()=>{e.newline(),e.moveToLineStart(),e.clearTilEnd(),e.render()},[E.ctrlD]:()=>r(),[E.ctrlE]:()=>e.moveToLineEnd(),[E.ctrlK]:()=>e.clearTilEnd(),[E.up]:()=>{e.moveToLineStart(),e.clearTilEnd(),e.insert(Rt.previous())},[E.down]:()=>{e.moveToLineStart(),e.clearTilEnd(),e.insert(Rt.next())},[E.right]:()=>e.moveRight(),[E.left]:()=>e.moveLeft(),[E.backspace]:()=>e.backspace(),[E.return]:()=>{e.newline(),p(),e.render()},[E.delete]:()=>{e.moveRight(),e.backspace()}};e.hideCursor(),u[i]?u[i]():c(),e.showCursor(),Rt.update(e.input.text.trim())}}a(jt,"lineKeyBinder");var Lt=class{constructor(r){this.lang=r}spashScreen(){console.log("help: ?\u23CE"),console.log("exit: CTRL-d")}async run(){return process.stdin.setRawMode(!0),process.stdin.setEncoding("utf8"),this.spashScreen(),process.stdin.resume(),new Promise(r=>{let t=jt(this.lang,()=>{process.stdin.destroy(),r(void 0)});process.stdin.on("data",e=>{t(e),process.stdin.resume()})})}};a(Lt,"Repl");var Nt=class extends Lt{};a(Nt,"Repl");process.stdin.pause();O.default.parse([{short:"r",long:"repl",description:"runs the repl"},{short:"t",long:"tokens",description:"prints tokens and exits "},{short:"p",long:"parse",description:"prints parse tree and exits "},{short:"v",long:"version",description:"prints version info and exits "}],[{name:"file"}],!0);var Tt=new yt;O.default.get("version")&&(console.log(`stox-${Tt.version}`),process.exit(0));var pe=O.default.get("tokens"),ce=O.default.get("parse"),le=pe&&"scan"||ce&&"parse"||"eval";Tt.options({stage:le});if(O.default.get("repl")&&process.stdout.isTTY)new Nt(Tt).run().finally(()=>process.exit(0));else{process.stdin.resume();let n=O.default.arg("file")??"/dev/stdin",r=Wt.default.readFileSync(n).toString();Tt.run(n,r),process.exit(Tt.errored?1:0)}
//# sourceMappingURL=stox.js.map