"use strict";var Pt=Object.create;var bt=Object.defineProperty;var Bt=Object.getOwnPropertyDescriptor;var Ht=Object.getOwnPropertyNames;var Vt=Object.getPrototypeOf,Qt=Object.prototype.hasOwnProperty;var a=(n,r)=>bt(n,"name",{value:r,configurable:!0});var jt=(n,r)=>()=>(r||n((r={exports:{}}).exports,r),r.exports);var qt=(n,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Ht(r))!Qt.call(n,s)&&s!==t&&bt(n,s,{get:()=>r[s],enumerable:!(e=Bt(r,s))||e.enumerable});return n};var Ct=(n,r,t)=>(t=n!=null?Pt(Vt(n)):{},qt(r||!n||!n.__esModule?bt(t,"default",{value:n,enumerable:!0}):t,n));var Ot=jt(g=>{var w=console.log,S={},It={},Ut=[],M=[],f={opts:[],args:[]};g.version="2.0.2";g.add=function(n,r){for(var t=0;t<n.length;t++)n[t].namespace=r,f.opts.push(n[t])};g.parse=function(n,r,t){if(r===!0)t=!0,r=[];else if(!r)r=[];else for(var e=0;e<r.length;e++)f.args.push(r[e]);t&&n.push({long:"help",description:"Show this help message",callback:g.help});for(var e=0;e<n.length;e++)f.opts.unshift(n[e]);n=f.opts;for(var s=a(function(u,E){var h=E=="short"?"-":"--",d=u[E];if(!i[h+d])i[h+d]=u;else if(u.namespace&&!i[h+u.namespace+"."+d]){i[h+u.namespace+"."+d]=u;for(var $=0;$<f.opts.length;$++){var tt=f.opts[$];tt.namespace==u.namespace&&(E=="long"&&tt.long==u.long?f.opts[$].long=u.namespace+"."+u.long:E=="short"&&delete f.opts[$].short)}}else w("Conflicting flags: "+h+d+`
`),w(wt()),process.exit(1)},"checkDup"),i={},e=0;e<n.length;e++)n[e].short&&s(n[e],"short"),n[e].long&&s(n[e],"long");for(var e=2;e<process.argv.length;e++){var l=process.argv[e];if(i[l]){var p=i[l];if(!p.value)p.callback&&p.callback(!0),p.short&&(S[p.short]=!0),p.long&&(S[p.long]=!0);else{var c=process.argv[e+1];if(!c||i[c]){var y=p.short||p.long;M.push("Missing value for option: "+y),p.short&&(S[p.short]=!0),p.long&&(S[p.long]=!0)}else p.callback&&p.callback(c),p.short&&(S[p.short]=c),p.long&&(S[p.long]=c),e++}}else if(l[0]=="-")w("Unknown option: "+l),i["--help"]&&w("Try --help"),process.exit(1);else{Ut.push(l);var v=r.shift();v&&(It[v.name]=l,v.callback&&v.callback(l))}}for(var e=0;e<n.length;e++){var y=n[e].short||n[e].long;n[e].required&&!g.get(y)&&M.push("Missing required option: "+y)}for(var e=0;e<r.length;e++)r[e].required&&!It[r[e].name]&&M.push("Missing required argument: "+r[e].name);if(M.length){for(var e=0;e<M.length;e++)w(M[e]);w(`
`+wt()),process.exit(1)}};g.get=function(n){return S[n]||S["-"+n]||S["--"+n]};g.values=function(){return Object.keys(S).reduce(function(n,r){return r=r.replace("/^-+/",""),n[r]=g.get(r),n},{})};g.args=function(){return Ut};g.arg=function(n){return It[n]};g.help=function(){w(wt()),process.exit(0)};var wt=a(function(){var n=process.argv[0].split(require("path").sep).pop(),r=process.argv[1].replace(process.cwd(),"."),t="Usage: "+n+" "+r;if(f.opts.length&&(t+=" [options]"),f.args.length)for(var e=0;e<f.args.length;e++)f.args[e].required?t+=" "+f.args[e].name:t+=" ["+f.args[e].name+"]";t+=`
`;for(var e=0;e<f.opts.length;e++){var s=f.opts[e];s.description&&(t+=s.description+`
`);var i="";s.short&&!s.long?i+="-"+s.short:s.long&&!s.short?i+="--"+s.long:i+="-"+s.short+", --"+s.long,s.value&&(i+=" <value>"),s.required&&(i+=" (required)"),t+="    "+i+`
`}return t},"helpString")});var Gt=Ct(require("fs")),_=Ct(Ot());var et=class{constructor(r=new A){this.reporter=r;this.opts={stage:"eval"};this.errored=!1}get interpreter(){return this._interpreter||(this._interpreter=new this.Interpreter(this.reporter)),this._interpreter}get resolver(){return this._resolver||(this._resolver=new this.Resolver(this.reporter,this.interpreter)),this._resolver}options(r){this.opts=r}run(r,t){this.errored=!1,this.reporter.pushSource(r,t),this.runToStage(t),this.reporter.popSource()}runToStage(r){let t=new this.Tokenizer(r,this.reporter),e=t.drain();if(this.reporter.errors&&(this.errored=!0,this.reporter.tokenError()),this.opts.stage==="scan"){t.print(e);return}let s=new this.Parser(e,this.reporter),i=s.parse();if(this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(!!i){if(this.resolver.visit(i),this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(this.opts.stage=="parse"){s.print(i);return}this.errored||(this.interpreter.visit(i),this.reporter.errors&&(this.errored=!0,this.reporter.runtimeError()))}}};a(et,"Language");var _t="__stoa__::error",P=class{constructor(r,t,e){this.name=r;this.text=t;this.pos=e}toString(){let r=`[${this.pos.line},${this.pos.column}]`;return`${this.name}${r}`}};a(P,"Token");var k=class{constructor(r,t,e,s=1,i=1){this.reporter=e;this.buffer=[];this.eof=!1;this.generator=zt(r,t,e,s,i)}take(){return this.peek(),this.buffer.shift()}peek(){return this.buffer.length||this.buffer.push(this.next()),this.buffer[0]}drain(){let r,t=[];for(;r=this.take();)t.push(r);return t}print(r=this.buffer,t="log"){console[t](r.map(e=>`${e}`).join(`
`))}next(){for(;;){if(this.eof)return;let r=this.generator.next().value;if(!r){this.eof=!0;continue}if(r.name==_t){this.reporter.error(r,"Unrecognized input");continue}if(!r.name.toString().startsWith("_"))return r}}};a(k,"TokenStream");function*zt(n,r,t,e,s){let i=0,l=e,p=s;for(;i<n.length;){let[u=_t,E=n[i]]=y(v()),h=new P(u,E,c()),d=E.split(`
`).length;d>1?(l+=d-1,p=E.length-E.lastIndexOf(`
`)):p+=E.length,i+=E.length,yield h}function c(){return{line:l,column:p}}a(c,"pos");function y(u){return u.length?u.length==1?u[0]:u.reduce((E,h)=>h[1].length>E[1].length||h[1].length==E[1].length&&!h[2]&&E[2]?h:E):[]}a(y,"longest");function v(){let u=[];return Object.entries(r).map(([E,h])=>{if(typeof h=="function"){let d=h(n.substring(i),t,l,p);d!==void 0&&u.push([E,d,!1])}else if(typeof h!="string"){let d=h.source[h.source.length-1]=="*",tt=new RegExp(`^${h.source}`,h.flags).exec(n.substring(i));if(tt)return u.push([E,tt[0],d])}else if(n.substring(i,i+h.length)==h)return u.push([E,h,!1])}),u}a(v,"possible")}a(zt,"tokenGenerator");var B={STRINGS:{STD:Jt},COMMENTS:{SHEBANG:/\#\!\/usr\/bin\/env\s.*/,DOUBLE_SLASH:/\/\/.*/,C_STYLE:Wt},SPACE:{ALL:/\s+/}};function Wt(n,r,t,e){let s=new k(n,{OPEN:"/*",CLOSE:"*/",ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&i.name=="OPEN"){let l=0,p,c=i.text;for(;p=s.take();)if(c+=p.text,p.name=="OPEN")l+=1;else if(p.name=="CLOSE")if(l)l-=1;else return c;return r.error(i,"Unclosed comment"),c}}a(Wt,"cStyleCommentScanner");function Jt(n,r,t,e){let s=new k(n,{SINGLE:"'",DOUBLE:'"',ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&["SINGLE","DOUBLE"].includes(i.name)){let{text:l}=i,p;for(;p=s.take();)if(l+=p.text,p.name==i.name)return l;return r.error(i,`Unclosed string, expected ${i.text}`),l}}a(Jt,"stringScanner");var rt=class{constructor(r,t){this.tokens=r;this.reporter=t;this.current=0}parse(){}print(r,t="log"){console[t](`${r??""}`)}match(...r){for(let t of r)if(this.check(t))return this.advance(),!0;return!1}consume(r,t){if(this.check(r))return this.advance();throw this.error(t)}error(r,t){let e=t||this.peek()||this.previous(),s=new Tt(r);if(!this.peek()){let i=e.text.split(`
`),l=i.length-1,p=e.pos.line+l,c=l?i[i.length-1].length+1:e.pos.column+e.text.length;e=new P("<EOF>","",{line:p,column:c}),s=new Lt(r)}return this.reporter.error(e,r),s}check(r){var t;return((t=this.peek())==null?void 0:t.name)==r}atEnd(){var r;return!((r=this.peek())!=null&&r.name)}advance(){return this.atEnd()||this.current++,this.previous()}peek(r=1){return this.tokens[this.current+(r-1)]}previous(){return this.tokens[this.current-1]}};a(rt,"Parser");var st=class{constructor(r=new A,t){this.reporter=r;this.interpreter=t}visit(r){let t=r.constructor.name,e=this[t];if(typeof e=="function")return e.bind(this)(r);throw new Error(`Unvisitable node: ${t} (UNIMPLEMENTED BY AUTHOR)`)}};a(st,"Visitor");var D=class extends Error{};a(D,"ParseError");var Tt=class extends D{};a(Tt,"InvalidParseTree");var Lt=class extends D{};a(Lt,"IncompleteParseTree");var A=class{constructor(){this.files=[];this._errors=[]}pushSource(r,t){this.files.push([r,t])}popSource(){this.files.pop()}error(r,t){this._errors.push([r,t])}get errors(){return this._errors.length?this._errors:!1}tokenError(){this.reportErrors("Syntax")}parseError(){this.reportErrors("Parse")}runtimeError(){this.reportErrors("Runtime")}reportErrors(r){let[t,e]=this.files[this.files.length-1],s=e.split(`
`);for(let[i,l]of this._errors){this.log(`${r} error in ${t} at line,col ${i.pos.line},${i.pos.column}`);let p=`${i.pos.line}. `,c=`${s[i.pos.line-1]}`;this.log(`${p}${c}`);let v=`${p}${c}`.replace(/./g," ").substring(0,p.length+i.pos.column-1);this.log(`${v}\u2191`),this.log(`${l}`)}this._errors=[]}log(r){console.error(r)}};a(A,"StdErrReporter");var x=class extends Error{constructor(t,e){super(e);this.token=t}};a(x,"RuntimeError");var $t="2022.08.15";var At=class extends k{constructor(r,t){super(r,At.lexicon,t)}},F=At;a(F,"Tokenizer"),F.lexicon={FALSE:/false/i,NIL:/nil/,NUMBER:/\d+(\.\d+)?/,STRING:B.STRINGS.STD,TRUE:/true/i,IDENTIFIER:/[a-z][a-z\d]*/i,AND:/and/i,BANG:"!",BANG_EQUAL:"!=",DASH:"-",EQUAL:"=",EQUAL_EQUAL:"==",GREATER:">",GREATER_EQUAL:">=",LESS:"<",LESS_EQUAL:"<=",NOT:/not/i,OR:/or/i,PLUS:"+",SLASH:"/",STAR:"*",COLON:":",COMMA:",",DOT:".",LEFT_CURL:"{",LEFT_PAREN:"(",QUESTION:"?",RIGHT_CURL:"}",RIGHT_PAREN:")",SEMICOLON:";",BREAK:/break/i,CLASS:/class/i,CONTINUE:/continue/i,ELSE:/else/i,FOR:/for/i,FUN:/fun/i,IF:/if/i,PRINT:/print/i,RETURN:/return/i,SUPER:/super/i,THIS:/this/i,VAR:/var/i,WHILE:/while/i,_SHEBANG_COMMENT:B.COMMENTS.SHEBANG,_MULTI_LINE_COMMENT:B.COMMENTS.C_STYLE,_SINGLE_LINE_COMMENT:B.COMMENTS.DOUBLE_SLASH,_SPACE:B.SPACE.ALL};var o=Object.keys(F.lexicon).reduce((n,r)=>(n[r]=r,n),{});var N=class extends st{};a(N,"Visitor");var nt=class{constructor(r,t){this.name=r;this.methods=t;this.arity=0}call(r){return new R(this)}findMethod(r){return this.methods.get(r)}toString(){return this.name}};a(nt,"Class");var R=class{constructor(r){this.klass=r;this.fields=new Map}get(r){if(this.fields.has(r.text))return this.fields.get(r.text);let t=this.klass.findMethod(r.text);if(t)return t.bind(this);throw new x(r,`Undefined property [${r.text}].`)}set(r,t){this.fields.set(r.text,t)}toString(){return`<<${this.klass.name} instance>>`}};a(R,"Instance");var it=class{constructor(r,t){this.name=r;this.value=t}};a(it,"AssignExpr");var T=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};a(T,"BinaryExpr");var ot=class{constructor(r,t,e){this.callee=r;this.args=t;this.end=e}};a(ot,"CallExpr");var at=class{constructor(r,t){this.params=r;this.block=t}};a(at,"FunctionExpr");var H=class{constructor(r,t){this.name=r;this.expr=t}};a(H,"GetExpr");var pt=class{constructor(r){this.inner=r}};a(pt,"GroupExpr");var m=class{constructor(r){this.value=r}toString(){if(this.value instanceof R)return this.value.toString();if(this.value===!0||this.value===!1)return`${this.value}`;if(this.value===void 0)return"nil";if(typeof this.value=="string")return this.value;let[r,t]=this.value;return`${r.toFixed(t)}`}};a(m,"LiteralExpr");var V=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};a(V,"LogicalExpr");var lt=class{constructor(r,t,e){this.name=r;this.expr=t;this.value=e}};a(lt,"SetExpr");var ct=class{constructor(r,t,e,s,i){this.left=r;this.op1=t;this.middle=e;this.op2=s;this.right=i}};a(ct,"TernaryExpr");var ht=class{constructor(r){this.name=r}};a(ht,"ThisExpr");var ut=class{constructor(r,t){this.operator=r;this.operand=t}};a(ut,"UnaryExpr");var Q=class{constructor(r){this.name=r}};a(Q,"VariableExpr");var q=class extends N{AssignExpr(r){return`(= ${r.name.text} ${this.visit(r.value)})`}BinaryExpr(r){let t=r.operator.text,e=this.visit(r.left),s=this.visit(r.right);return`(${t} ${e} ${s})`}BlockStmt(r){let t=r.statements.map(e=>this.visit(e)).join(`
`);return`(block 
${j(t)}
)`}CallExpr(r){let t=`(call ${this.visit(r.callee)}`;if(!r.args.length)return`${t})`;let e=r.args.map(s=>this.visit(s)).join(" ");return`${t} ${e})`}ClassDecl(r){let t=r.funcs.map(e=>this.visit(e)).join(`
`);return`(class ${r.name.text}
${j(t)}
)`}ExpressionStmt(r){return this.visit(r.expr)}FunctionExpr(r){let t=r.params.map(s=>s.text).join(" "),e=this.visit(r.block);return`(let [${t}] ${e})`}FunctionDecl(r){let t=r.name.text,e=this.visit(r.func);return`(fun ${t} ${e})`}GetExpr(r){return`(.get ${this.visit(r.expr)} ${r.name.text})`}GroupExpr(r){return`(group ${this.visit(r.inner)})`}IfStmt(r){let t=this.visit(r.condition),e=this.visit(r.trueStatement);if(!r.falseStatement)return`(if ${t} ${e})`;let s=this.visit(r.falseStatement);return`(if ${t} 
${j(e)} 
${j(s)})`}JumpStmt(r){let t=r.keyword.name,e=this.visit(r.distance||new m([1,0]));return`(${t} ${e})`}LiteralExpr(r){let t=r.toString();return typeof r.value=="string"?JSON.stringify(t):t}LogicalExpr(r){return this.BinaryExpr(r)}PrintStmt(r){return`(print ${this.visit(r.expr)})`}Program(r){let t=r.code.map(e=>this.visit(e)).join(`
`);return`(program 
${j(t)}
)`}ReturnStmt(r){return`(return ${this.visit(r.expr)})`}SetExpr(r){return`(.set ${this.visit(r.expr)} ${r.name.text} ${this.visit(r.value)})`}ThisExpr(r){return"this"}TernaryExpr(r){let t=this.visit(r.left),e=this.visit(r.middle),s=this.visit(r.right);return`(?: ${t} ${e} ${s})`}UnaryExpr(r){let t=r.operator.text,e=this.visit(r.operand);return`(${t} ${e})`}VariableDecl(r){let t=`(var ${r.name.text}`,e=r.expr?` ${this.visit(r.expr)}`:"";return`${t}${e})`}VariableExpr(r){return`${r.name.text}`}WhileStmt(r){let t=this.visit(r.condition),e=this.visit(r.body);return`(while ${t} 
${j(e)}
)`}};a(q,"Printer");function j(n){let r=new Array(3).fill(" ").join("");return n.replace(/^/mg,r)}a(j,"indent");var mt=class{constructor(r,t){this.name=r;this.funcs=t}};a(mt,"ClassDecl");var Et=class{constructor(r,t){this.name=r;this.func=t}};a(Et,"FunctionDecl");var xt=class{constructor(r,t){this.name=r;this.expr=t}};a(xt,"VariableDecl");var ft=class{constructor(r){this.code=r}};a(ft,"Program");var C=class{constructor(r){this.statements=r}};a(C,"BlockStmt");var z=class{constructor(r){this.expr=r}};a(z,"ExpressionStmt");var W=class{constructor(r,t,e){this.condition=r;this.trueStatement=t;this.falseStatement=e}};a(W,"IfStmt");var dt=class{constructor(r,t){this.keyword=r;this.distance=t}};a(dt,"JumpStmt");var gt=class{constructor(r){this.expr=r}};a(gt,"PrintStmt");var vt=class{constructor(r,t){this.expr=r;this.keyword=t}};a(vt,"ReturnStmt");var J=class{constructor(r,t){this.condition=r;this.body=t}};a(J,"WhileStmt");var St=class extends rt{parse(){return this._parsed||(this._parsed=this.Program()),this._parsed}toString(){return this._parsed?new q().visit(this._parsed):"un-parsed"}print(t=this._parsed,e="log"){let s=t?new q().visit(t):"()";console[e](s)}Program(){let t=[];for(;!this.atEnd();){let e=this.Declaration();e&&t.push(e)}return new ft(t)}Declaration(){var t,e;try{return((t=this.peek())==null?void 0:t.name)==o.FUN&&((e=this.peek(2))==null?void 0:e.name)==o.IDENTIFIER?(this.match(o.FUN),this.FunDeclaration()):this.match(o.CLASS)?this.ClassDeclaration():this.match(o.VAR)?this.VarDeclaration():this.Statement()}catch(s){if(s instanceof D){this.synchronize();return}else throw s}}ClassDeclaration(){let t=this.consume("IDENTIFIER","Expected identifier");this.consume(o.LEFT_CURL,'Expected "{"');let e=[];for(;;){let s=this.FunDeclaration();if(!s)break;e.push(s)}return this.consume(o.RIGHT_CURL,'Expected "}"'),new mt(t,e)}FunDeclaration(){var t;if(((t=this.peek())==null?void 0:t.name)==o.IDENTIFIER){let e=this.consume("IDENTIFIER","Expected identifier"),s=this.FunctionExpr();return new Et(e,s)}}FunctionExpr(){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Parameters();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Block();if(!e)throw this.error("Expected {");return new at(t,e)}Parameters(){var e,s;let t=[];if(((e=this.peek())==null?void 0:e.name)!=o.RIGHT_PAREN){t.length>=255&&this.error("Too many params (255 max)");do{let i=this.consume(o.IDENTIFIER,"expected param name");t.push(i)}while(((s=this.peek())==null?void 0:s.name)==o.COMMA)}return t}VarDeclaration(){let t=this.consume("IDENTIFIER","Expected identifier"),e;return this.match(o.EQUAL)&&(e=this.Expression()),this.consume(o.SEMICOLON,"Expected ;"),new xt(t,e)}Statement(){return this.PrintStatement()||this.ReturnStatement()||this.IfStatement()||this.WhileStatement()||this.ForStatement()||this.JumpStatement()||this.Block()||this.ExpressionStatement()}ReturnStatement(){if(this.match(o.RETURN)){let t=this.previous(),e=new m(void 0);return this.match(o.SEMICOLON)||(e=this.Expression(),this.consume(o.SEMICOLON,"Expected ;")),new vt(e,t)}}Block(){var t;if(this.match(o.LEFT_CURL)){let e=[];for(;!this.atEnd()&&((t=this.peek())==null?void 0:t.name)!=o.RIGHT_CURL;){let i=this.Declaration();i&&e.push(i)}let s=new C(e);return this.consume(o.RIGHT_CURL,"Expected }"),s}}JumpStatement(){var t;if(this.match(o.BREAK,o.CONTINUE)){let e=this.previous(),s=new m([1,0]);return((t=this.peek())==null?void 0:t.name)!=o.SEMICOLON&&(s=this.Expression()),this.consume(o.SEMICOLON,"Expected ;"),new dt(e,s)}}IfStatement(){if(this.match(o.IF)){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Statement();if(this.match(o.ELSE)){let s=this.Statement();return new W(t,e,s)}else return new W(t,e)}}WhileStatement(){if(this.match(o.WHILE)){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Statement();return new J(t,e)}}ForStatement(){var t,e;if(this.match(o.FOR)){this.consume(o.LEFT_PAREN,"Expected (");let s=this.match(o.VAR)&&this.VarDeclaration()||this.ExpressionStatement()||this.consume(o.SEMICOLON,"Expected ;")&&new m(!0),i=new m(!0);((t=this.peek())==null?void 0:t.name)!=o.SEMICOLON&&(i=this.Expression()),this.consume(o.SEMICOLON,"Expected ;");let l=new m(!0);((e=this.peek())==null?void 0:e.name)!=o.RIGHT_PAREN&&(l=this.Expression()),this.consume(o.RIGHT_PAREN,"Expected )");let p=this.Statement();return new C([s,new J(i,new C([p,new z(l)]))])}}PrintStatement(){if(this.match(o.PRINT)){let t=this.Expression();return this.consume(o.SEMICOLON,"Expected ;"),new gt(t)}}ExpressionStatement(){let t=this.Expression();return this.consume(o.SEMICOLON,"Expected ;"),new z(t)}Expression(){return this.Comma()}Comma(){let t=this.Assignment();for(;this.match(o.COMMA);){let e=this.previous(),s=this.Assignment();t=new T(t,e,s)}return t}Assignment(){let t=this.LogicOr();if(this.match(o.EQUAL)){let e=this.previous(),s=this.Assignment();if(t instanceof Q)return new it(t.name,s);if(t instanceof H)return new lt(t.name,t.expr,s);this.error("Invalid assignment target",e)}return t}LogicOr(){let t=this.LogicAnd();for(;this.match(o.OR);){let e=this.previous(),s=this.LogicAnd();t=new V(t,e,s)}return t}LogicAnd(){let t=this.Conditional();for(;this.match(o.AND);){let e=this.previous(),s=this.Conditional();t=new V(t,e,s)}return t}Conditional(){let t=this.Equality();for(;this.match(o.QUESTION);){let e=this.previous(),s=this.Equality();this.consume(o.COLON,"Expected :");let i=this.previous(),l=this.Equality();t=new ct(t,e,s,i,l)}return t}Equality(){let t=this.Comparison();for(;this.match(o.BANG_EQUAL,o.EQUAL_EQUAL);){let e=this.previous(),s=this.Comparison();t=new T(t,e,s)}return t}Comparison(){let t=this.Term();for(;this.match(o.LESS,o.GREATER,o.LESS_EQUAL,o.GREATER_EQUAL);){let e=this.previous(),s=this.Term();t=new T(t,e,s)}return t}Term(){let t=this.Factor();for(;this.match(o.PLUS,o.DASH);){let e=this.previous(),s=this.Factor();t=new T(t,e,s)}return t}Factor(){let t=this.Unary();for(;this.match(o.STAR,o.SLASH);){let e=this.previous(),s=this.Unary();t=new T(t,e,s)}return t}Unary(){for(;this._InvalidUnary(););return this._ValidUnary()}_InvalidUnary(){if(this.match(o.PLUS,o.STAR,o.SLASH))return this.error("Binary operator is missing the left operand",this.previous()),this.previous(),this.Unary()}_ValidUnary(){if(this.match(o.BANG,o.DASH)){let t=this.previous(),e=this.Unary();return new ut(t,e)}return this.Call()}Call(){let t=this.Primary();for(;;)if(this.match(o.LEFT_PAREN)){let e=[];if(!this.check(o.RIGHT_PAREN)){e.length>=255&&this.error("Too many args (255 max)");do e.push(this.Expression());while(this.match(o.COMMA))}let s=this.consume(o.RIGHT_PAREN,"Expected ) after arguments");t=new ot(t,e,s)}else if(this.match(o.DOT)){let e=this.consume(o.IDENTIFIER,"Expected method or attribute name");t=new H(e,t)}else break;return t}Primary(){if(this.match(o.NUMBER)){let t=this.previous().text,e=parseFloat(t),s=`${t}.`.split(".")[1].length;return new m([e,s])}if(this.match(o.STRING)){let t=this.previous().text,[e,...s]=t.split("");return e===s[s.length-1]&&s.pop(),new m(s.join(""))}if(this.match(o.TRUE))return new m(!0);if(this.match(o.FALSE))return new m(!1);if(this.match(o.NIL))return new m(void 0);if(this.match(o.THIS))return new ht(this.previous());if(this.match(o.IDENTIFIER))return new Q(this.previous());if(this.match(o.LEFT_PAREN)){let t=this.Expression();return this.consume(o.RIGHT_PAREN,'Expected ")" after expression'),new pt(t)}if(this.match(o.FUN))return this.FunctionExpr();throw this.error("Expected to find an expression")}synchronize(){var t;for(this.advance();!this.atEnd();){if(this.previous().name=="SEMICOLON")return;switch(((t=this.peek())==null?void 0:t.name)??""){case"CLASS":case"FOR":case"FUN":case"IF":case"PRINT":case"RETURN":case"VAR":case"WHILE":return}this.advance()}}};a(St,"Parser");var yt=class extends N{constructor(t,e){super();this.reporter=t;this.evaluator=e;this.currentFunction=0;this.scopes=[]}beginScope(){this.scopes.unshift({})}endScope(){this.scopes.shift()}declare(t){let e=this.scopes[0];!e||(e[t.text]===0&&this.reporter.error(t,"Variable is already declared"),e[t.text]===1&&this.reporter.error(t,"Variable is already defined"),e[t.text]=0)}define(t){let e=this.scopes[0];!e||(e[t.text]=1)}resolveLocal(t,e){this.scopes.find((s,i)=>s[e.text]?(this.evaluator.resolve(t,i),!0):!1)}resolveFunction(t,e){let s=this.currentFunction;this.currentFunction=e,this.beginScope();for(let i of t.params)this.declare(i),this.define(i);this.visit(t.block),this.endScope(),this.currentFunction=s}AssignExpr(t){this.visit(t.value),this.resolveLocal(t,t.name)}BinaryExpr(t){this.visit(t.left),this.visit(t.right)}BlockStmt(t){this.beginScope();for(let e of t.statements)this.visit(e);this.endScope()}CallExpr(t){this.visit(t.callee);for(let e of t.args)this.visit(e)}ClassDecl(t){this.declare(t.name),this.define(t.name),this.beginScope(),this.scopes[0].this=0;for(let e of t.funcs)this.resolveFunction(e.func,2);this.endScope()}ExpressionStmt(t){this.visit(t.expr)}FunctionExpr(t){this.resolveFunction(t,1)}FunctionDecl(t){this.declare(t.name),this.define(t.name),this.resolveFunction(t.func,1)}GetExpr(t){this.visit(t.expr)}GroupExpr(t){this.visit(t.inner)}IfStmt(t){this.visit(t.condition),this.visit(t.trueStatement),t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){this.visit(t.distance)}LiteralExpr(t){}LogicalExpr(t){this.visit(t.left),this.visit(t.right)}PrintStmt(t){this.visit(t.expr)}Program(t){for(let e of t.code)this.visit(e)}ReturnStmt(t){this.currentFunction==0&&this.reporter.error(t.keyword,"No return from top-level allowed"),this.visit(t.expr)}SetExpr(t){this.visit(t.value),this.visit(t.expr)}ThisExpr(t){this.resolveLocal(t,t.name)}TernaryExpr(t){this.visit(t.left),this.visit(t.middle),this.visit(t.right)}UnaryExpr(t){this.visit(t.operand)}VariableDecl(t){this.declare(t.name),t.expr&&this.visit(t.expr),this.define(t.name)}VariableExpr(t){let e=this.scopes[0];!e||(e[t.name.text]===0&&this.reporter.error(t.name,"Reference to uninitialized variable"),this.resolveLocal(t,t.name))}WhileStmt(t){this.visit(t.condition),this.visit(t.body)}};a(yt,"Resolver");var b=class{constructor(r){this.enclosure=r;this.table=new Map}has(r){var t;return this.table.has(r.text)||!!((t=this.enclosure)!=null&&t.has(r))}init(r){this.table.has(r.text)||this.table.set(r.text,void 0)}set(r,t,e=0){var s;if(e>0&&this.enclosure)return this.enclosure.set(r,t,e-1);if(this.table.has(r.text))this.table.set(r.text,t);else if((s=this.enclosure)!=null&&s.has(r))this.enclosure.set(r,t);else throw new x(r,`No such variable: ${r.text}`)}get(r,t=0){var e;if(t>0&&this.enclosure)return this.enclosure.get(r,t-1);if(this.table.has(r.text))return this.table.get(r.text);if((e=this.enclosure)!=null&&e.has(r))return this.enclosure.get(r);throw new x(r,`Undefined variable: ${r.text}`)}};a(b,"Environment");function Mt(n){n.globals.init({text:"clock"}),n.globals.set({text:"clock"},{arity:0,call(){return new Date().toLocaleString()}})}a(Mt,"registerGlobals");function L(n){return Array.isArray(n)&&n.length==2}a(L,"isNumber");function Ft(n){return typeof n=="string"}a(Ft,"isString");function I(n){return!(n===!1||n===void 0)}a(I,"truthy");var U=class{constructor(r=void 0){this.value=r}};a(U,"ReturnException");var O=class{constructor(r=1){this.distance=r}};a(O,"JumpException");var K=class extends O{};a(K,"BreakException");var Y=class extends O{};a(Y,"ContinueException");function Z(n){return n?!!n.call:!1}a(Z,"isCallable");var X=class{constructor(r,t){this.arity=r;this.call=t}bind(r){return this}};a(X,"Function");var Nt=class extends N{constructor(t){super();this.reporter=t;this.globals=new b;this.env=this.globals;this.locals=new Map;Mt(this)}resolve(t,e){this.locals.set(t,e)}lookUpVariable(t,e){let s=this.locals.get(e);return s!==void 0?this.env.get(t,s):this.globals.get(t)}AssignExpr(t){let e=this.visit(t.value),s=this.locals.get(t);return s!==void 0?this.env.set(t.name,e,s):this.globals.set(t.name,e),e}BinaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=this.visit(t.right);if(e==o.COMMA)return i;if(e==o.PLUS&&(Ft(s)||Ft(i))){let l=Z(s)?s:new m(s),p=Z(i)?i:new m(i);return`${l}${p}`}if(e==o.EQUAL_EQUAL)return L(s)&&L(i)?s[0]==i[0]:s===i;if(e==o.BANG_EQUAL)return L(s)&&L(i)?s[0]!=i[0]:s!==i;if(!L(s)||!L(i))throw new x(t.operator,"number values expected");if(i[0]==0)throw new x(t.operator,"divide by zero");if(e==o.PLUS)return[s[0]+i[0],Math.max(s[1],i[1])];if(e==o.DASH)return[s[0]-i[0],Math.max(s[1],i[1])];if(e==o.STAR)return[s[0]*i[0],Math.max(s[1],i[1])];if(e==o.SLASH)return[s[0]/i[0],Math.max(s[1],i[1])];if(e==o.GREATER)return s[0]>i[0];if(e==o.GREATER_EQUAL)return s[0]>=i[0];if(e==o.LESS)return s[0]<i[0];if(e==o.LESS_EQUAL)return s[0]<=i[0];throw new x(t.operator,"Unexpected binary expression")}BlockStmt(t){let e=this.env;this.env=new b(e);try{t.statements.map(s=>this.visit(s))}finally{this.env=e}}CallExpr(t){let e=this.visit(t.callee);if(!Z(e))throw new x(t.end,"uncallable target");if(e.arity!=t.args.length)throw new x(t.end,"wrong number of args");return e.call(t.args.map(s=>this.visit(s)))}ClassDecl(t){this.env.init(t.name);let e=new Map;for(let i of t.funcs){let l=new X(i.func.params.length,p=>{try{p.map((c,y)=>{let v=i.func.params[y];this.env.init(v),this.env.set(v,c)}),this.visit(i.func.block)}catch(c){if(c instanceof U)return c.value;throw c}});e.set(i.name.text,l)}let s=new nt(t.name.text,e);this.env.set(t.name,s)}ExpressionStmt(t){this.visit(t.expr)}FunctionDecl(t){let e=this.FunctionExpr(t.func);this.env.init(t.name),this.env.set(t.name,e)}FunctionExpr(t){let e=new b(this.env);return new X(t.params.length,s=>{let i=this.env;this.env=new b(e);try{s.map((l,p)=>{let c=t.params[p];this.env.init(c),this.env.set(c,l)}),this.visit(t.block)}catch(l){if(l instanceof U)return l.value;throw l}finally{this.env=i}})}GetExpr(t){let e=this.visit(t.expr);if(e instanceof R)return e.get(t.name);throw new x(t.name,"Only instances have properties")}GroupExpr(t){return this.visit(t.inner)}IfStmt(t){let e=this.visit(t.condition);I(e)?this.visit(t.trueStatement):t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){let e=this.visit(t.distance||new m([1,0]));throw L(e)?t.keyword.name==o.BREAK?new K(e[0]):new Y(e[0]):new x(t.keyword,"expected numerical distance")}LiteralExpr(t){return t.value}LogicalExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=I(s);if(e==o.OR&&i||e==o.AND&&!i)return s;let l=this.visit(t.right);return I(l)?l:I(!1)}PrintStmt(t){let e=this.visit(t.expr),s=Z(e)?e:new m(e).toString();console.log(s+"")}Program(t){try{let e=t.code.map(i=>this.visit(i)),s=e[e.length-1];return Z(s)?`${s}`:new m(s).toString()}catch(e){e instanceof x?this.reporter.error(e.token,e.message):this.reporter.error(void 0,e.message)}}ReturnStmt(t){let e=this.visit(t.expr);throw new U(e)}SetExpr(t){let e=this.visit(t.expr);if(!(e instanceof R))throw new x(t.name,"Only instances have fields");let s=this.visit(t.value);return e.set(t.name,s),s}TernaryExpr(t){let{op1:{name:e},op2:{name:s}}=t;if(e==o.QUESTION&&s==o.COLON){let i=this.visit(t.left);return I(i)?this.visit(t.middle):this.visit(t.right)}throw new x(e,"Unexpected ternary expression")}ThisExpr(t){this.lookUpVariable(t.name,t)}UnaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.operand);if(e==o.BANG)return!I(s);if(!L(s))throw new x(e,"must negate a number value");if(e==o.DASH)return[-s[0],s[1]];throw new x(e,"Unexpected unary expression")}VariableDecl(t){this.env.init(t.name);let e=t.expr?this.visit(t.expr):void 0;this.env.set(t.name,e)}VariableExpr(t){return this.lookUpVariable(t.name,t)}WhileStmt(t){for(;I(this.visit(t.condition));)try{this.visit(t.body)}catch(e){if(e instanceof O){if(e.distance>1)throw e.distance-=1,e;if(e instanceof Y)continue;if(e instanceof K)break}}}};a(Nt,"Interpreter");var Rt=class extends et{constructor(){super(...arguments);this.version=$t;this.Tokenizer=F;this.Parser=St;this.Resolver=yt;this.Interpreter=Nt}};a(Rt,"StoxLang");process.stdin.pause();_.default.parse([{short:"r",long:"repl",description:"runs the repl"},{short:"t",long:"tokens",description:"prints tokens and exits "},{short:"p",long:"parse",description:"prints parse tree and exits "},{short:"v",long:"version",description:"prints version info and exits "}],[{name:"file"}],!0);var kt=new Rt;_.default.get("version")&&(console.log(`stox-${kt.version}`),process.exit(0));var te=_.default.get("tokens"),ee=_.default.get("parse"),re=te&&"scan"||ee&&"parse"||"eval";kt.options({stage:re});if(!(_.default.get("repl")&&process.stdout.isTTY)){process.stdin.resume();let n=_.default.arg("file")??"/dev/stdin",r=Gt.default.readFileSync(n).toString();kt.run(n,r),process.exit(kt.errored?1:0)}
//# sourceMappingURL=stox.js.map