"use strict";var _t=Object.create;var Lt=Object.defineProperty;var $t=Object.getOwnPropertyDescriptor;var Pt=Object.getOwnPropertyNames;var Bt=Object.getPrototypeOf,Mt=Object.prototype.hasOwnProperty;var a=(n,r)=>Lt(n,"name",{value:r,configurable:!0});var Gt=(n,r)=>()=>(r||n((r={exports:{}}).exports,r),r.exports);var Vt=(n,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Pt(r))!Mt.call(n,s)&&s!==t&&Lt(n,s,{get:()=>r[s],enumerable:!(e=$t(r,s))||e.enumerable});return n};var It=(n,r,t)=>(t=n!=null?_t(Bt(n)):{},Vt(r||!n||!n.__esModule?Lt(t,"default",{value:n,enumerable:!0}):t,n));var Dt=Gt(g=>{var w=console.log,S={},Rt={},At=[],_=[],f={opts:[],args:[]};g.version="2.0.2";g.add=function(n,r){for(var t=0;t<n.length;t++)n[t].namespace=r,f.opts.push(n[t])};g.parse=function(n,r,t){if(r===!0)t=!0,r=[];else if(!r)r=[];else for(var e=0;e<r.length;e++)f.args.push(r[e]);t&&n.push({long:"help",description:"Show this help message",callback:g.help});for(var e=0;e<n.length;e++)f.opts.unshift(n[e]);n=f.opts;for(var s=a(function(u,m){var l=m=="short"?"-":"--",d=u[m];if(!i[l+d])i[l+d]=u;else if(u.namespace&&!i[l+u.namespace+"."+d]){i[l+u.namespace+"."+d]=u;for(var O=0;O<f.opts.length;O++){var J=f.opts[O];J.namespace==u.namespace&&(m=="long"&&J.long==u.long?f.opts[O].long=u.namespace+"."+u.long:m=="short"&&delete f.opts[O].short)}}else w("Conflicting flags: "+l+d+`
`),w(Tt()),process.exit(1)},"checkDup"),i={},e=0;e<n.length;e++)n[e].short&&s(n[e],"short"),n[e].long&&s(n[e],"long");for(var e=2;e<process.argv.length;e++){var c=process.argv[e];if(i[c]){var p=i[c];if(!p.value)p.callback&&p.callback(!0),p.short&&(S[p.short]=!0),p.long&&(S[p.long]=!0);else{var E=process.argv[e+1];if(!E||i[E]){var b=p.short||p.long;_.push("Missing value for option: "+b),p.short&&(S[p.short]=!0),p.long&&(S[p.long]=!0)}else p.callback&&p.callback(E),p.short&&(S[p.short]=E),p.long&&(S[p.long]=E),e++}}else if(c[0]=="-")w("Unknown option: "+c),i["--help"]&&w("Try --help"),process.exit(1);else{At.push(c);var L=r.shift();L&&(Rt[L.name]=c,L.callback&&L.callback(c))}}for(var e=0;e<n.length;e++){var b=n[e].short||n[e].long;n[e].required&&!g.get(b)&&_.push("Missing required option: "+b)}for(var e=0;e<r.length;e++)r[e].required&&!Rt[r[e].name]&&_.push("Missing required argument: "+r[e].name);if(_.length){for(var e=0;e<_.length;e++)w(_[e]);w(`
`+Tt()),process.exit(1)}};g.get=function(n){return S[n]||S["-"+n]||S["--"+n]};g.values=function(){return Object.keys(S).reduce(function(n,r){return r=r.replace("/^-+/",""),n[r]=g.get(r),n},{})};g.args=function(){return At};g.arg=function(n){return Rt[n]};g.help=function(){w(Tt()),process.exit(0)};var Tt=a(function(){var n=process.argv[0].split(require("path").sep).pop(),r=process.argv[1].replace(process.cwd(),"."),t="Usage: "+n+" "+r;if(f.opts.length&&(t+=" [options]"),f.args.length)for(var e=0;e<f.args.length;e++)f.args[e].required?t+=" "+f.args[e].name:t+=" ["+f.args[e].name+"]";t+=`
`;for(var e=0;e<f.opts.length;e++){var s=f.opts[e];s.description&&(t+=s.description+`
`);var i="";s.short&&!s.long?i+="-"+s.short:s.long&&!s.short?i+="--"+s.long:i+="-"+s.short+", --"+s.long,s.value&&(i+=" <value>"),s.required&&(i+=" (required)"),t+="    "+i+`
`}return t},"helpString")});var Ot=It(require("fs")),U=It(Dt());var Y=class{constructor(r=new I){this.reporter=r;this.opts={stage:"eval"};this.errored=!1}get interpreter(){return this._interpreter||(this._interpreter=new this.Interpreter(this.reporter)),this._interpreter}get resolver(){return this._resolver||(this._resolver=new this.Resolver(this.reporter,this.interpreter)),this._resolver}options(r){this.opts=r}run(r,t){this.errored=!1,this.reporter.pushSource(r,t),this.runToStage(t),this.reporter.popSource()}runToStage(r){let t=new this.Tokenizer(r,this.reporter),e=t.drain();if(this.reporter.errors&&(this.errored=!0,this.reporter.tokenError()),this.opts.stage==="scan"){t.print(e);return}let s=new this.Parser(e,this.reporter),i=s.parse();if(this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(!!i){if(this.resolver.visit(i),this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(this.opts.stage=="parse"){s.print(i);return}this.errored||(this.interpreter.visit(i),this.reporter.errors&&(this.errored=!0,this.reporter.runtimeError()))}}};a(Y,"Language");var Ct="__stoa__::error",P=class{constructor(r,t,e){this.name=r;this.text=t;this.pos=e}toString(){let r=`[${this.pos.line},${this.pos.column}]`;return`${this.name}${r}`}};a(P,"Token");var R=class{constructor(r,t,e,s=1,i=1){this.reporter=e;this.buffer=[];this.eof=!1;this.generator=Ht(r,t,e,s,i)}take(){return this.peek(),this.buffer.shift()}peek(){return this.buffer.length||this.buffer.push(this.next()),this.buffer[0]}drain(){let r,t=[];for(;r=this.take();)t.push(r);return t}print(r=this.buffer,t="log"){console[t](r.map(e=>`${e}`).join(`
`))}next(){for(;;){if(this.eof)return;let r=this.generator.next().value;if(!r){this.eof=!0;continue}if(r.name==Ct){this.reporter.error(r,"Unrecognized input");continue}if(!r.name.toString().startsWith("_"))return r}}};a(R,"TokenStream");function*Ht(n,r,t,e,s){let i=0,c=e,p=s;for(;i<n.length;){let[u=Ct,m=n[i]]=b(L()),l=new P(u,m,E()),d=m.split(`
`).length;d>1?(c+=d-1,p=m.length-m.lastIndexOf(`
`)):p+=m.length,i+=m.length,yield l}function E(){return{line:c,column:p}}a(E,"pos");function b(u){return u.length?u.length==1?u[0]:u.reduce((m,l)=>l[1].length>m[1].length||l[1].length==m[1].length&&!l[2]&&m[2]?l:m):[]}a(b,"longest");function L(){let u=[];return Object.entries(r).map(([m,l])=>{if(typeof l=="function"){let d=l(n.substring(i),t,c,p);d!==void 0&&u.push([m,d,!1])}else if(typeof l!="string"){let d=l.source[l.source.length-1]=="*",J=new RegExp(`^${l.source}`,l.flags).exec(n.substring(i));if(J)return u.push([m,J[0],d])}else if(n.substring(i,i+l.length)==l)return u.push([m,l,!1])}),u}a(L,"possible")}a(Ht,"tokenGenerator");var B={STRINGS:{STD:qt},COMMENTS:{SHEBANG:/\#\!\/usr\/bin\/env\s.*/,DOUBLE_SLASH:/\/\/.*/,C_STYLE:Qt},SPACE:{ALL:/\s+/}};function Qt(n,r,t,e){let s=new R(n,{OPEN:"/*",CLOSE:"*/",ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&i.name=="OPEN"){let c=0,p,E=i.text;for(;p=s.take();)if(E+=p.text,p.name=="OPEN")c+=1;else if(p.name=="CLOSE")if(c)c-=1;else return E;return r.error(i,"Unclosed comment"),E}}a(Qt,"cStyleCommentScanner");function qt(n,r,t,e){let s=new R(n,{SINGLE:"'",DOUBLE:'"',ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&["SINGLE","DOUBLE"].includes(i.name)){let{text:c}=i,p;for(;p=s.take();)if(c+=p.text,p.name==i.name)return c;return r.error(i,`Unclosed string, expected ${i.text}`),c}}a(qt,"stringScanner");var X=class{constructor(r,t){this.tokens=r;this.reporter=t;this.current=0}parse(){}print(r,t="log"){console[t](`${r??""}`)}match(...r){for(let t of r)if(this.check(t))return this.advance(),!0;return!1}consume(r,t){if(this.check(r))return this.advance();throw this.error(t)}error(r,t){let e=t||this.peek()||this.previous(),s=new yt(r);if(!this.peek()){let i=e.text.split(`
`),c=i.length-1,p=e.pos.line+c,E=c?i[i.length-1].length+1:e.pos.column+e.text.length;e=new P("<EOF>","",{line:p,column:E}),s=new Nt(r)}return this.reporter.error(e,r),s}check(r){var t;return((t=this.peek())==null?void 0:t.name)==r}atEnd(){var r;return!((r=this.peek())!=null&&r.name)}advance(){return this.atEnd()||this.current++,this.previous()}peek(r=1){return this.tokens[this.current+(r-1)]}previous(){return this.tokens[this.current-1]}};a(X,"Parser");var Z=class{constructor(r=new I,t){this.reporter=r;this.interpreter=t}visit(r){let t=r.constructor.name,e=this[t];if(typeof e=="function")return e.bind(this)(r);throw new Error(`Unvisitable node: ${t} (UNIMPLEMENTED BY AUTHOR)`)}};a(Z,"Visitor");var A=class extends Error{};a(A,"ParseError");var yt=class extends A{};a(yt,"InvalidParseTree");var Nt=class extends A{};a(Nt,"IncompleteParseTree");var I=class{constructor(){this.files=[];this._errors=[]}pushSource(r,t){this.files.push([r,t])}popSource(){this.files.pop()}error(r,t){this._errors.push([r,t])}get errors(){return this._errors.length?this._errors:!1}tokenError(){this.reportErrors("Syntax")}parseError(){this.reportErrors("Parse")}runtimeError(){this.reportErrors("Runtime")}reportErrors(r){let[t,e]=this.files[this.files.length-1],s=e.split(`
`);for(let[i,c]of this._errors){this.log(`${r} error in ${t} at line,col ${i.pos.line},${i.pos.column}`);let p=`${i.pos.line}. `,E=`${s[i.pos.line-1]}`;this.log(`${p}${E}`);let L=`${p}${E}`.replace(/./g," ").substring(0,p.length+i.pos.column-1);this.log(`${L}\u2191`),this.log(`${c}`)}this._errors=[]}log(r){console.error(r)}};a(I,"StdErrReporter");var x=class extends Error{constructor(t,e){super(e);this.token=t}};a(x,"RuntimeError");var Ft="2022.08.15";var kt=class extends R{constructor(r,t){super(r,kt.lexicon,t)}},D=kt;a(D,"Tokenizer"),D.lexicon={FALSE:/false/i,NIL:/nil/,NUMBER:/\d+(\.\d+)?/,STRING:B.STRINGS.STD,TRUE:/true/i,IDENTIFIER:/[a-z][a-z\d]*/i,AND:/and/i,BANG:"!",BANG_EQUAL:"!=",DASH:"-",EQUAL:"=",EQUAL_EQUAL:"==",GREATER:">",GREATER_EQUAL:">=",LESS:"<",LESS_EQUAL:"<=",NOT:/not/i,OR:/or/i,PLUS:"+",SLASH:"/",STAR:"*",COLON:":",COMMA:",",DOT:".",LEFT_CURL:"{",LEFT_PAREN:"(",QUESTION:"?",RIGHT_CURL:"}",RIGHT_PAREN:")",SEMICOLON:";",BREAK:/break/i,CLASS:/class/i,CONTINUE:/continue/i,ELSE:/else/i,FOR:/for/i,FUN:/fun/i,IF:/if/i,PRINT:/print/i,RETURN:/return/i,SUPER:/super/i,THIS:/this/i,VAR:/var/i,WHILE:/while/i,_SHEBANG_COMMENT:B.COMMENTS.SHEBANG,_MULTI_LINE_COMMENT:B.COMMENTS.C_STYLE,_SINGLE_LINE_COMMENT:B.COMMENTS.DOUBLE_SLASH,_SPACE:B.SPACE.ALL};var o=Object.keys(D.lexicon).reduce((n,r)=>(n[r]=r,n),{});var v=class extends Z{};a(v,"Visitor");var tt=class{constructor(r,t){this.name=r;this.value=t}};a(tt,"AssignExpr");var y=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};a(y,"BinaryExpr");var et=class{constructor(r,t,e){this.callee=r;this.args=t;this.end=e}};a(et,"CallExpr");var rt=class{constructor(r,t){this.params=r;this.block=t}};a(rt,"FunctionExpr");var st=class{constructor(r){this.inner=r}};a(st,"GroupExpr");var h=class{constructor(r){this.value=r}toString(){if(this.value===!0||this.value===!1)return`${this.value}`;if(this.value===void 0)return"nil";if(typeof this.value=="string")return this.value;let[r,t]=this.value;return`${r.toFixed(t)}`}};a(h,"LiteralExpr");var M=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};a(M,"LogicalExpr");var nt=class{constructor(r,t,e,s,i){this.left=r;this.op1=t;this.middle=e;this.op2=s;this.right=i}};a(nt,"TernaryExpr");var it=class{constructor(r,t){this.operator=r;this.operand=t}};a(it,"UnaryExpr");var G=class{constructor(r){this.name=r}};a(G,"VariableExpr");var V=class extends v{AssignExpr(r){return`(= ${r.name.text} ${this.visit(r.value)})`}BinaryExpr(r){let t=r.operator.text,e=this.visit(r.left),s=this.visit(r.right);return`(${t} ${e} ${s})`}BlockStmt(r){let t=r.statements.map(e=>this.visit(e)).join(`
`);return`(block 
${ot(t)}
)`}CallExpr(r){let t=`(call ${this.visit(r.callee)}`;if(!r.args.length)return`${t})`;let e=r.args.map(s=>this.visit(s)).join(" ");return`${t} ${e})`}ExpressionStmt(r){return this.visit(r.expr)}FunctionExpr(r){let t=r.params.map(s=>s.text).join(" "),e=this.visit(r.block);return`(let [${t}] ${e})`}FunctionDecl(r){let t=r.name.text,e=this.visit(r.func);return`(fun ${t} ${e})`}GroupExpr(r){return`(group ${this.visit(r.inner)})`}IfStmt(r){let t=this.visit(r.condition),e=this.visit(r.trueStatement);if(!r.falseStatement)return`(if ${t} ${e})`;let s=this.visit(r.falseStatement);return`(if ${t} 
${ot(e)} 
${ot(s)})`}JumpStmt(r){let t=r.keyword.name,e=this.visit(r.distance||new h([1,0]));return`(${t} ${e})`}LiteralExpr(r){return r.toString()}LogicalExpr(r){return this.BinaryExpr(r)}PrintStmt(r){return`(print ${this.visit(r.expr)})`}Program(r){let t=r.code.map(e=>this.visit(e)).join(`
`);return`(program 
${ot(t)}
)`}ReturnStmt(r){return`(return ${this.visit(r.expr)})`}TernaryExpr(r){let t=this.visit(r.left),e=this.visit(r.middle),s=this.visit(r.right);return`(?: ${t} ${e} ${s})`}UnaryExpr(r){let t=r.operator.text,e=this.visit(r.operand);return`(${t} ${e})`}VariableDecl(r){let t=`(var ${r.name.text}`,e=r.expr?` ${this.visit(r.expr)}`:"";return`${t}${e})`}VariableExpr(r){return`${r.name.text}`}WhileStmt(r){let t=this.visit(r.condition),e=this.visit(r.body);return`(while ${t} 
${ot(e)}
)`}};a(V,"Printer");function ot(n){let r=new Array(3).fill(" ").join("");return n.replace(/^/mg,r)}a(ot,"indent");var at=class{constructor(r,t){this.name=r;this.func=t}};a(at,"FunctionDecl");var pt=class{constructor(r,t){this.name=r;this.expr=t}};a(pt,"VariableDecl");var ct=class{constructor(r){this.code=r}};a(ct,"Program");var C=class{constructor(r){this.statements=r}};a(C,"BlockStmt");var H=class{constructor(r){this.expr=r}};a(H,"ExpressionStmt");var Q=class{constructor(r,t,e){this.condition=r;this.trueStatement=t;this.falseStatement=e}};a(Q,"IfStmt");var lt=class{constructor(r,t){this.keyword=r;this.distance=t}};a(lt,"JumpStmt");var ut=class{constructor(r){this.expr=r}};a(ut,"PrintStmt");var ht=class{constructor(r,t){this.expr=r;this.keyword=t}};a(ht,"ReturnStmt");var q=class{constructor(r,t){this.condition=r;this.body=t}};a(q,"WhileStmt");var mt=class extends X{parse(){return this._parsed||(this._parsed=this.Program()),this._parsed}toString(){return this._parsed?new V().visit(this._parsed):"un-parsed"}print(t=this._parsed,e="log"){let s=t?new V().visit(t):"()";console[e](s)}Program(){let t=[];for(;!this.atEnd();){let e=this.Declaration();e&&t.push(e)}return new ct(t)}Declaration(){try{return this.FunDeclaration()||this.VarDeclaration()||this.Statement()}catch(t){if(t instanceof A){this.synchronize();return}else throw t}}FunDeclaration(){var t,e;if(((t=this.peek(1))==null?void 0:t.name)==o.FUN&&((e=this.peek(2))==null?void 0:e.name)==o.IDENTIFIER){this.match(o.FUN);let s=this.consume("IDENTIFIER","Expected identifier"),i=this.Function();return new at(s,i)}}Function(){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Parameters();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Block();if(!e)throw this.error("Expected {");return new rt(t,e)}Parameters(){var e,s;let t=[];if(((e=this.peek())==null?void 0:e.name)!=o.RIGHT_PAREN){t.length>=255&&this.error("Too many params (255 max)");do{let i=this.consume(o.IDENTIFIER,"expected param name");t.push(i)}while(((s=this.peek())==null?void 0:s.name)==o.COMMA)}return t}VarDeclaration(){if(this.match(o.VAR)){let t=this.consume("IDENTIFIER","Expected identifier"),e;return this.match(o.EQUAL)&&(e=this.Expression()),this.consume(o.SEMICOLON,"Expected ;"),new pt(t,e)}}Statement(){return this.PrintStatement()||this.ReturnStatement()||this.IfStatement()||this.WhileStatement()||this.ForStatement()||this.JumpStatement()||this.Block()||this.ExpressionStatement()}ReturnStatement(){if(this.match(o.RETURN)){let t=this.previous(),e=new h(void 0);return this.match(o.SEMICOLON)||(e=this.Expression(),this.consume(o.SEMICOLON,"Expected ;")),new ht(e,t)}}Block(){var t;if(this.match(o.LEFT_CURL)){let e=[];for(;!this.atEnd()&&((t=this.peek())==null?void 0:t.name)!=o.RIGHT_CURL;){let i=this.Declaration();i&&e.push(i)}let s=new C(e);return this.consume(o.RIGHT_CURL,"Expected }"),s}}JumpStatement(){var t;if(this.match(o.BREAK,o.CONTINUE)){let e=this.previous(),s=new h([1,0]);return((t=this.peek())==null?void 0:t.name)!=o.SEMICOLON&&(s=this.Expression()),this.consume(o.SEMICOLON,"Expected ;"),new lt(e,s)}}IfStatement(){if(this.match(o.IF)){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Statement();if(this.match(o.ELSE)){let s=this.Statement();return new Q(t,e,s)}else return new Q(t,e)}}WhileStatement(){if(this.match(o.WHILE)){this.consume(o.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(o.RIGHT_PAREN,"Expected )");let e=this.Statement();return new q(t,e)}}ForStatement(){var t,e;if(this.match(o.FOR)){this.consume(o.LEFT_PAREN,"Expected (");let s=this.VarDeclaration()||this.ExpressionStatement()||this.consume(o.SEMICOLON,"Expected ;")&&new h(!0),i=new h(!0);((t=this.peek())==null?void 0:t.name)!=o.SEMICOLON&&(i=this.Expression()),this.consume(o.SEMICOLON,"Expected ;");let c=new h(!0);((e=this.peek())==null?void 0:e.name)!=o.RIGHT_PAREN&&(c=this.Expression()),this.consume(o.RIGHT_PAREN,"Expected )");let p=this.Statement();return new C([s,new q(i,new C([p,new H(c)]))])}}PrintStatement(){if(this.match(o.PRINT)){let t=this.Expression();return this.consume(o.SEMICOLON,"Expected ;"),new ut(t)}}ExpressionStatement(){let t=this.Expression();return this.consume(o.SEMICOLON,"Expected ;"),new H(t)}Expression(){return this.Comma()}Comma(){let t=this.Assignment();for(;this.match(o.COMMA);){let e=this.previous(),s=this.Assignment();t=new y(t,e,s)}return t}Assignment(){let t=this.LogicOr();if(this.match(o.EQUAL)){let e=this.previous(),s=this.Assignment();if(t instanceof G)return new tt(t.name,s);this.error("Invalid assignment target",e)}return t}LogicOr(){let t=this.LogicAnd();for(;this.match(o.OR);){let e=this.previous(),s=this.LogicAnd();t=new M(t,e,s)}return t}LogicAnd(){let t=this.Conditional();for(;this.match(o.AND);){let e=this.previous(),s=this.Conditional();t=new M(t,e,s)}return t}Conditional(){let t=this.Equality();for(;this.match(o.QUESTION);){let e=this.previous(),s=this.Equality();this.consume(o.COLON,"Expected :");let i=this.previous(),c=this.Equality();t=new nt(t,e,s,i,c)}return t}Equality(){let t=this.Comparison();for(;this.match(o.BANG_EQUAL,o.EQUAL_EQUAL);){let e=this.previous(),s=this.Comparison();t=new y(t,e,s)}return t}Comparison(){let t=this.Term();for(;this.match(o.LESS,o.GREATER,o.LESS_EQUAL,o.GREATER_EQUAL);){let e=this.previous(),s=this.Term();t=new y(t,e,s)}return t}Term(){let t=this.Factor();for(;this.match(o.PLUS,o.DASH);){let e=this.previous(),s=this.Factor();t=new y(t,e,s)}return t}Factor(){let t=this.Unary();for(;this.match(o.STAR,o.SLASH);){let e=this.previous(),s=this.Unary();t=new y(t,e,s)}return t}Unary(){for(;this._InvalidUnary(););return this._ValidUnary()}_InvalidUnary(){if(this.match(o.PLUS,o.STAR,o.SLASH))return this.error("Binary operator is missing the left operand",this.previous()),this.previous(),this.Unary()}_ValidUnary(){if(this.match(o.BANG,o.DASH)){let t=this.previous(),e=this.Unary();return new it(t,e)}return this.Call()}Call(){let t=this.Primary();if(!this.check(o.LEFT_PAREN))return t;for(;this.match(o.LEFT_PAREN);){let e=[];if(!this.check(o.RIGHT_PAREN)){e.length>=255&&this.error("Too many args (255 max)");do e.push(this.Expression());while(this.match(o.COMMA))}let s=this.consume(o.RIGHT_PAREN,"Expected ) after arguments");t=new et(t,e,s)}return t}Primary(){if(this.match(o.NUMBER)){let t=this.previous().text,e=parseFloat(t),s=`${t}.`.split(".")[1].length;return new h([e,s])}if(this.match(o.STRING)){let t=this.previous().text,[e,...s]=t.split("");return e===s[s.length-1]&&s.pop(),new h(s.join(""))}if(this.match(o.TRUE))return new h(!0);if(this.match(o.FALSE))return new h(!1);if(this.match(o.NIL))return new h(void 0);if(this.match(o.IDENTIFIER))return new G(this.previous());if(this.match(o.LEFT_PAREN)){let t=this.Expression();return this.consume(o.RIGHT_PAREN,'Expected ")" after expression'),new st(t)}if(this.match(o.FUN))return this.Function();throw this.error("Expected to find an expression")}synchronize(){var t;for(this.advance();!this.atEnd();){if(this.previous().name=="SEMICOLON")return;switch(((t=this.peek())==null?void 0:t.name)??""){case"CLASS":case"FOR":case"FUN":case"IF":case"PRINT":case"RETURN":case"VAR":case"WHILE":return}this.advance()}}};a(mt,"Parser");var Et=class extends v{constructor(t,e){super();this.reporter=t;this.evaluator=e;this.currentFunction=0;this.scopes=[]}beginScope(){this.scopes.unshift({})}endScope(){this.scopes.shift()}declare(t){let e=this.scopes[0];!e||(e[t.text]===0&&this.reporter.error(t,"Variable is already declared"),e[t.text]===1&&this.reporter.error(t,"Variable is already defined"),e[t.text]=0)}define(t){let e=this.scopes[0];!e||(e[t.text]=1)}resolveLocal(t,e){this.scopes.find((s,i)=>s[e.text]?(this.evaluator.resolve(t,i),!0):!1)}resolveFunction(t,e){let s=this.currentFunction;this.currentFunction=e,this.beginScope();for(let i of t.params)this.declare(i),this.define(i);this.visit(t.block),this.endScope(),this.currentFunction=s}AssignExpr(t){this.visit(t.value),this.resolveLocal(t,t.name)}BinaryExpr(t){this.visit(t.left),this.visit(t.right)}BlockStmt(t){this.beginScope();for(let e of t.statements)this.visit(e);this.endScope()}CallExpr(t){this.visit(t.callee);for(let e of t.args)this.visit(e)}ExpressionStmt(t){this.visit(t.expr)}FunctionExpr(t){this.resolveFunction(t,1)}FunctionDecl(t){this.declare(t.name),this.define(t.name),this.resolveFunction(t.func,1)}GroupExpr(t){this.visit(t.inner)}IfStmt(t){this.visit(t.condition),this.visit(t.trueStatement),t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){this.visit(t.distance)}LiteralExpr(t){}LogicalExpr(t){this.visit(t.left),this.visit(t.right)}PrintStmt(t){this.visit(t.expr)}Program(t){for(let e of t.code)this.visit(e)}ReturnStmt(t){this.currentFunction==0&&this.reporter.error(t.keyword,"No return from top-level allowed"),this.visit(t.expr)}TernaryExpr(t){this.visit(t.left),this.visit(t.middle),this.visit(t.right)}UnaryExpr(t){this.visit(t.operand)}VariableDecl(t){this.declare(t.name),t.expr&&this.visit(t.expr),this.define(t.name)}VariableExpr(t){let e=this.scopes[0];!e||(e[t.name.text]===0&&this.reporter.error(t.name,"Reference to uninitialized variable"),this.resolveLocal(t,t.name))}WhileStmt(t){this.visit(t.condition),this.visit(t.body)}};a(Et,"Resolver");var T=class{constructor(r){this.enclosure=r;this.table=new Map}has(r){var t;return this.table.has(r.text)||!!((t=this.enclosure)!=null&&t.has(r))}init(r){this.table.has(r.text)||this.table.set(r.text,void 0)}set(r,t,e=0){var s;if(e>0&&this.enclosure)return this.enclosure.set(r,t,e-1);if(this.table.has(r.text))this.table.set(r.text,t);else if((s=this.enclosure)!=null&&s.has(r))this.enclosure.set(r,t);else throw new x(r,`No such variable: ${r.text}`)}get(r,t=0){var e;if(t>0&&this.enclosure)return this.enclosure.get(r,t-1);if(this.table.has(r.text))return this.table.get(r.text);if((e=this.enclosure)!=null&&e.has(r))return this.enclosure.get(r);throw new x(r,`Undefined variable: ${r.text}`)}};a(T,"Environment");function Ut(n){n.globals.init({text:"clock"}),n.globals.set({text:"clock"},{arity:0,call(){return new Date().toLocaleString()}})}a(Ut,"registerGlobals");function N(n){return Array.isArray(n)&&n.length==2}a(N,"isNumber");function wt(n){return typeof n=="string"}a(wt,"isString");function k(n){return!(n===!1||n===void 0)}a(k,"truthy");var j=class{constructor(r=void 0){this.value=r}};a(j,"ReturnException");var F=class{constructor(r=1){this.distance=r}};a(F,"JumpException");var z=class extends F{};a(z,"BreakException");var W=class extends F{};a(W,"ContinueException");function K(n){return n?!!n.call:!1}a(K,"isCallable");var xt=class{constructor(r,t){this.arity=r;this.call=t}};a(xt,"Function");var ft=class extends v{constructor(t){super();this.reporter=t;this.globals=new T;this.env=this.globals;this.locals=new Map;Ut(this)}resolve(t,e){this.locals.set(t,e)}lookUpVariable(t,e){let s=this.locals.get(e);return s!==void 0?this.env.get(t,s):this.globals.get(t)}AssignExpr(t){let e=this.visit(t.value),s=this.locals.get(t);return s!==void 0?this.env.set(t.name,e,s):this.globals.set(t.name,e),e}BinaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=this.visit(t.right);if(e==o.COMMA)return i;if(e==o.PLUS&&(wt(s)||wt(i))){let c=K(s)?s:new h(s),p=K(i)?i:new h(i);return`${c}${p}`}if(e==o.EQUAL_EQUAL)return N(s)&&N(i)?s[0]==i[0]:s===i;if(e==o.BANG_EQUAL)return N(s)&&N(i)?s[0]!=i[0]:s!==i;if(!N(s)||!N(i))throw new x(t.operator,"number values expected");if(i[0]==0)throw new x(t.operator,"divide by zero");if(e==o.PLUS)return[s[0]+i[0],Math.max(s[1],i[1])];if(e==o.DASH)return[s[0]-i[0],Math.max(s[1],i[1])];if(e==o.STAR)return[s[0]*i[0],Math.max(s[1],i[1])];if(e==o.SLASH)return[s[0]/i[0],Math.max(s[1],i[1])];if(e==o.GREATER)return s[0]>i[0];if(e==o.GREATER_EQUAL)return s[0]>=i[0];if(e==o.LESS)return s[0]<i[0];if(e==o.LESS_EQUAL)return s[0]<=i[0];throw new x(t.operator,"Unexpected binary expression")}BlockStmt(t){let e=this.env;this.env=new T(e);try{t.statements.map(s=>this.visit(s))}finally{this.env=e}}CallExpr(t){let e=this.visit(t.callee);if(!K(e))throw new x(t.end,"uncallable target");if(e.arity!=t.args.length)throw new x(t.end,"wrong number of args");return e.call(t.args.map(s=>this.visit(s)))}ExpressionStmt(t){this.visit(t.expr)}FunctionExpr(t){let e=new T(this.env);return new xt(t.params.length,s=>{let i=this.env;this.env=new T(e);try{s.map((c,p)=>{let E=t.params[p];this.env.init(E),this.env.set(E,c)}),this.visit(t.block)}catch(c){if(c instanceof j)return c.value;throw c}finally{this.env=i}})}FunctionDecl(t){let e=this.FunctionExpr(t.func);this.env.init(t.name),this.env.set(t.name,e)}GroupExpr(t){return this.visit(t.inner)}IfStmt(t){let e=this.visit(t.condition);k(e)?this.visit(t.trueStatement):t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){let e=this.visit(t.distance||new h([1,0]));throw N(e)?t.keyword.name==o.BREAK?new z(e[0]):new W(e[0]):new x(t.keyword,"expected numerical distance")}LiteralExpr(t){return t.value}LogicalExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=k(s);if(e==o.OR&&i||e==o.AND&&!i)return s;let c=this.visit(t.right);return k(c)?c:k(!1)}PrintStmt(t){let e=this.visit(t.expr),s=K(e)?e:new h(e).toString();console.log(s+"")}Program(t){try{let e=t.code.map(i=>this.visit(i)),s=e[e.length-1];return K(s)?`${s}`:new h(s).toString()}catch(e){e instanceof x?this.reporter.error(e.token,e.message):this.reporter.error(void 0,e.message)}}ReturnStmt(t){let e=this.visit(t.expr);throw new j(e)}TernaryExpr(t){let{op1:{name:e},op2:{name:s}}=t;if(e==o.QUESTION&&s==o.COLON){let i=this.visit(t.left);return k(i)?this.visit(t.middle):this.visit(t.right)}throw new x(e,"Unexpected ternary expression")}UnaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.operand);if(e==o.BANG)return!k(s);if(!N(s))throw new x(e,"must negate a number value");if(e==o.DASH)return[-s[0],s[1]];throw new x(e,"Unexpected unary expression")}VariableDecl(t){this.env.init(t.name);let e=t.expr?this.visit(t.expr):void 0;this.env.set(t.name,e)}VariableExpr(t){return this.lookUpVariable(t.name,t)}WhileStmt(t){for(;k(this.visit(t.condition));)try{this.visit(t.body)}catch(e){if(e instanceof F){if(e.distance>1)throw e.distance-=1,e;if(e instanceof W)continue;if(e instanceof z)break}}}};a(ft,"Interpreter");var dt=class extends Y{constructor(){super(...arguments);this.version=Ft;this.Tokenizer=D;this.Parser=mt;this.Resolver=Et;this.Interpreter=ft}};a(dt,"StoxLang");var gt=class{constructor(r){this.lang=r;this.prompt_width=0}prompt(){this.prompt_width=2,process.stdout.write("> ")}async run(){let{stdin:r,stdout:t}=process;r.setRawMode(!0),r.setEncoding("utf8"),console.log("help: ?\u23CE"),console.log("exit: CTRL-d"),r.resume();let e="";return this.prompt(),new Promise(s=>{r.on("data",i=>{r.pause(),[""].includes(i.toString())&&(r.destroy(),s(void 0)),i.toString().match(/[\p{Cc}\p{Cn}\p{Cs}]+/gu)||(e+=i.toString(),t.write(i)),i.toString()=="\x1B[C"&&process.stdout.moveCursor(-1,0),i.toString()=="\x1B[D"&&process.stdout.moveCursor(1,0),["\x7F"].includes(i.toString())&&(e=e.substring(0,e.length-1),process.stdout.cursorTo(0),process.stdout.clearLine(0),this.prompt(),t.write(e)),["\r",`
`].includes(i.toString())&&(process.stdout.moveCursor(0,1),process.stdout.cursorTo(0),console.log(""),this.lang.run("repl",e),e="",this.prompt()),r.resume()})})}};a(gt,"Repl");var St=class extends gt{};a(St,"Repl");process.stdin.pause();U.default.parse([{short:"r",long:"repl",description:"runs the repl"},{short:"t",long:"tokens",description:"prints tokens and exits "},{short:"p",long:"parse",description:"prints parse tree and exits "},{short:"v",long:"version",description:"prints version info and exits "}],[{name:"file"}],!0);var vt=new dt;U.default.get("version")&&(console.log(`stox-${vt.version}`),process.exit(0));var Yt=U.default.get("tokens"),Xt=U.default.get("parse"),Zt=Yt&&"scan"||Xt&&"parse"||"eval";vt.options({stage:Zt});if(U.default.get("repl")&&process.stdout.isTTY)new St(vt).run().finally(()=>process.exit(0));else{process.stdin.resume();let n=U.default.arg("file")??"/dev/stdin",r=Ot.default.readFileSync(n).toString();vt.run(n,r),process.exit(vt.errored?1:0)}
//# sourceMappingURL=stox.js.map