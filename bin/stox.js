"use strict";var Kt=Object.create;var Ut=Object.defineProperty;var Jt=Object.getOwnPropertyDescriptor;var Yt=Object.getOwnPropertyNames;var Xt=Object.getPrototypeOf,Zt=Object.prototype.hasOwnProperty;var o=(n,r)=>Ut(n,"name",{value:r,configurable:!0});var te=(n,r)=>()=>(r||n((r={exports:{}}).exports,r),r.exports);var ee=(n,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Yt(r))!Zt.call(n,s)&&s!==t&&Ut(n,s,{get:()=>r[s],enumerable:!(e=Jt(r,s))||e.enumerable});return n};var Gt=(n,r,t)=>(t=n!=null?Kt(Xt(n)):{},ee(r||!n||!n.__esModule?Ut(t,"default",{value:n,enumerable:!0}):t,n));var Vt=te(S=>{var D=console.log,y={},_t={},Pt=[],M=[],d={opts:[],args:[]};S.version="2.0.2";S.add=function(n,r){for(var t=0;t<n.length;t++)n[t].namespace=r,d.opts.push(n[t])};S.parse=function(n,r,t){if(r===!0)t=!0,r=[];else if(!r)r=[];else for(var e=0;e<r.length;e++)d.args.push(r[e]);t&&n.push({long:"help",description:"Show this help message",callback:S.help});for(var e=0;e<n.length;e++)d.opts.unshift(n[e]);n=d.opts;for(var s=o(function(h,x){var l=x=="short"?"-":"--",v=h[x];if(!i[l+v])i[l+v]=h;else if(h.namespace&&!i[l+h.namespace+"."+v]){i[l+h.namespace+"."+v]=h;for(var B=0;B<d.opts.length;B++){var tt=d.opts[B];tt.namespace==h.namespace&&(x=="long"&&tt.long==h.long?d.opts[B].long=h.namespace+"."+h.long:x=="short"&&delete d.opts[B].short)}}else D("Conflicting flags: "+l+v+`
`),D(Ot()),process.exit(1)},"checkDup"),i={},e=0;e<n.length;e++)n[e].short&&s(n[e],"short"),n[e].long&&s(n[e],"long");for(var e=2;e<process.argv.length;e++){var c=process.argv[e];if(i[c]){var p=i[c];if(!p.value)p.callback&&p.callback(!0),p.short&&(y[p.short]=!0),p.long&&(y[p.long]=!0);else{var u=process.argv[e+1];if(!u||i[u]){var g=p.short||p.long;M.push("Missing value for option: "+g),p.short&&(y[p.short]=!0),p.long&&(y[p.long]=!0)}else p.callback&&p.callback(u),p.short&&(y[p.short]=u),p.long&&(y[p.long]=u),e++}}else if(c[0]=="-")D("Unknown option: "+c),i["--help"]&&D("Try --help"),process.exit(1);else{Pt.push(c);var T=r.shift();T&&(_t[T.name]=c,T.callback&&T.callback(c))}}for(var e=0;e<n.length;e++){var g=n[e].short||n[e].long;n[e].required&&!S.get(g)&&M.push("Missing required option: "+g)}for(var e=0;e<r.length;e++)r[e].required&&!_t[r[e].name]&&M.push("Missing required argument: "+r[e].name);if(M.length){for(var e=0;e<M.length;e++)D(M[e]);D(`
`+Ot()),process.exit(1)}};S.get=function(n){return y[n]||y["-"+n]||y["--"+n]};S.values=function(){return Object.keys(y).reduce(function(n,r){return r=r.replace("/^-+/",""),n[r]=S.get(r),n},{})};S.args=function(){return Pt};S.arg=function(n){return _t[n]};S.help=function(){D(Ot()),process.exit(0)};var Ot=o(function(){var n=process.argv[0].split(require("path").sep).pop(),r=process.argv[1].replace(process.cwd(),"."),t="Usage: "+n+" "+r;if(d.opts.length&&(t+=" [options]"),d.args.length)for(var e=0;e<d.args.length;e++)d.args[e].required?t+=" "+d.args[e].name:t+=" ["+d.args[e].name+"]";t+=`
`;for(var e=0;e<d.opts.length;e++){var s=d.opts[e];s.description&&(t+=s.description+`
`);var i="";s.short&&!s.long?i+="-"+s.short:s.long&&!s.short?i+="--"+s.long:i+="-"+s.short+", --"+s.long,s.value&&(i+=" <value>"),s.required&&(i+=" (required)"),t+="    "+i+`
`}return t},"helpString")});var zt=Gt(require("fs")),$=Gt(Vt());var et=class{constructor(r=new C){this.reporter=r;this.opts={stage:"eval"};this.errored=!1}get interpreter(){return this._interpreter||(this._interpreter=new this.Interpreter(this.reporter)),this._interpreter}get resolver(){return this._resolver||(this._resolver=new this.Resolver(this.reporter,this.interpreter)),this._resolver}options(r){this.opts=r}run(r,t){this.errored=!1,this.reporter.pushSource(r,t),this.runToStage(t),this.reporter.popSource()}runToStage(r){let t=new this.Tokenizer(r,this.reporter),e=t.drain();if(this.reporter.errors&&(this.errored=!0,this.reporter.tokenError()),this.opts.stage==="scan"){t.print(e);return}let s=new this.Parser(e,this.reporter),i=s.parse();if(this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(!!i){if(this.resolver.visit(i),this.reporter.errors){this.errored=!0,this.reporter.parseError();return}if(this.opts.stage=="parse"){s.print(i);return}this.errored||(this.interpreter.visit(i),this.reporter.errors&&(this.errored=!0,this.reporter.runtimeError()))}}};o(et,"Language");var Ht="__stoa__::error",P=class{constructor(r,t,e){this.name=r;this.text=t;this.pos=e}toString(){let r=`[${this.pos.line},${this.pos.column}]`;return`${this.name}${r}`}};o(P,"Token");var k=class{constructor(r,t,e,s=1,i=1){this.reporter=e;this.buffer=[];this.eof=!1;this.generator=re(r,t,e,s,i)}take(){return this.peek(),this.buffer.shift()}peek(){return this.buffer.length||this.buffer.push(this.next()),this.buffer[0]}drain(){let r,t=[];for(;r=this.take();)t.push(r);return t}print(r=this.buffer,t="log"){console[t](r.map(e=>`${e}`).join(`
`))}next(){for(;;){if(this.eof)return;let r=this.generator.next().value;if(!r){this.eof=!0;continue}if(r.name==Ht){this.reporter.error(r,"Unrecognized input");continue}if(!r.name.toString().startsWith("_"))return r}}};o(k,"TokenStream");function*re(n,r,t,e,s){let i=0,c=e,p=s;for(;i<n.length;){let[h=Ht,x=n[i]]=g(T()),l=new P(h,x,u()),v=x.split(`
`).length;v>1?(c+=v-1,p=x.length-x.lastIndexOf(`
`)):p+=x.length,i+=x.length,yield l}function u(){return{line:c,column:p}}o(u,"pos");function g(h){return h.length?h.length==1?h[0]:h.reduce((x,l)=>l[1].length>x[1].length||l[1].length==x[1].length&&!l[2]&&x[2]?l:x):[]}o(g,"longest");function T(){let h=[];return Object.entries(r).map(([x,l])=>{if(typeof l=="function"){let v=l(n.substring(i),t,c,p);v!==void 0&&h.push([x,v,!1])}else if(typeof l!="string"){let v=l.source[l.source.length-1]=="*",tt=new RegExp(`^${l.source}`,l.flags).exec(n.substring(i));if(tt)return h.push([x,tt[0],v])}else if(n.substring(i,i+l.length)==l)return h.push([x,l,!1])}),h}o(T,"possible")}o(re,"tokenGenerator");var V={STRINGS:{STD:ne},COMMENTS:{SHEBANG:/\#\!\/usr\/bin\/env\s.*/,DOUBLE_SLASH:/\/\/.*/,C_STYLE:se},SPACE:{ALL:/\s+/}};function se(n,r,t,e){let s=new k(n,{OPEN:"/*",CLOSE:"*/",ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&i.name=="OPEN"){let c=0,p,u=i.text;for(;p=s.take();)if(u+=p.text,p.name=="OPEN")c+=1;else if(p.name=="CLOSE")if(c)c-=1;else return u;return r.error(i,"Unclosed comment"),u}}o(se,"cStyleCommentScanner");function ne(n,r,t,e){let s=new k(n,{SINGLE:"'",DOUBLE:'"',ESCAPED_CHAR:/\\./,CHAR:/.|\s/},r,t,e),i=s.take();if(i&&["SINGLE","DOUBLE"].includes(i.name)){let{text:c}=i,p;for(;p=s.take();)if(c+=p.text,p.name==i.name)return c;return r.error(i,`Unclosed string, expected ${i.text}`),c}}o(ne,"stringScanner");var rt=class{constructor(r,t){this.tokens=r;this.reporter=t;this.current=0}parse(){}print(r,t="log"){console[t](`${r??""}`)}match(...r){for(let t of r)if(this.check(t))return this.advance(),!0;return!1}consume(r,t){if(this.check(r))return this.advance();throw this.error(t)}error(r,t){let e=t||this.peek()||this.previous(),s=new It(r);if(!this.peek()){let i=e.text.split(`
`),c=i.length-1,p=e.pos.line+c,u=c?i[i.length-1].length+1:e.pos.column+e.text.length;e=new P("<EOF>","",{line:p,column:u}),s=new At(r)}return this.reporter.error(e,r),s}check(r){var t;return((t=this.peek())==null?void 0:t.name)==r}atEnd(){var r;return!((r=this.peek())!=null&&r.name)}advance(){return this.atEnd()||this.current++,this.previous()}peek(r=1){return this.tokens[this.current+(r-1)]}previous(){return this.tokens[this.current-1]}};o(rt,"Parser");var st=class{constructor(r=new C,t){this.reporter=r;this.interpreter=t}visit(r){let t=r.constructor.name,e=this[t];if(typeof e=="function")return e.bind(this)(r);throw new Error(`Unvisitable node: ${t} (UNIMPLEMENTED BY AUTHOR)`)}};o(st,"Visitor");var F=class extends Error{};o(F,"ParseError");var It=class extends F{};o(It,"InvalidParseTree");var At=class extends F{};o(At,"IncompleteParseTree");var C=class{constructor(){this.files=[];this._errors=[]}pushSource(r,t){this.files.push([r,t])}popSource(){this.files.pop()}error(r,t){this._errors.push([r,t])}get errors(){return this._errors.length?this._errors:!1}tokenError(){this.reportErrors("Syntax")}parseError(){this.reportErrors("Parse")}runtimeError(){this.reportErrors("Runtime")}reportErrors(r){let[t,e]=this.files[this.files.length-1],s=e.split(`
`);for(let[i,c]of this._errors){this.log(`${r} error in ${t} at line,col ${i.pos.line},${i.pos.column}`);let p=`${i.pos.line}. `,u=`${s[i.pos.line-1]}`;this.log(`${p}${u}`);let T=`${p}${u}`.replace(/./g," ").substring(0,p.length+i.pos.column-1);this.log(`${T}\u2191`),this.log(`${c}`)}this._errors=[]}log(r){console.error(r)}};o(C,"StdErrReporter");var E=class extends Error{constructor(t,e){super(e);this.token=t}};o(E,"RuntimeError");var Qt="2022.08.15";var $t=class extends k{constructor(r,t){super(r,$t.lexicon,t)}},U=$t;o(U,"Tokenizer"),U.lexicon={FALSE:/false/i,NIL:/nil/,NUMBER:/\d+(\.\d+)?/,STRING:V.STRINGS.STD,TRUE:/true/i,IDENTIFIER:/[a-z][a-z\d]*/i,AND:/and/i,BANG:"!",BANG_EQUAL:"!=",DASH:"-",EQUAL:"=",EQUAL_EQUAL:"==",GREATER:">",GREATER_EQUAL:">=",LESS:"<",LESS_EQUAL:"<=",NOT:/not/i,OR:/or/i,PLUS:"+",SLASH:"/",STAR:"*",COLON:":",COMMA:",",DOT:".",LEFT_CURL:"{",LEFT_PAREN:"(",QUESTION:"?",RIGHT_CURL:"}",RIGHT_PAREN:")",SEMICOLON:";",BREAK:/break/i,CLASS:/class/i,CONTINUE:/continue/i,ELSE:/else/i,FOR:/for/i,FUN:/fun/i,IF:/if/i,PRINT:/print/i,RETURN:/return/i,SUPER:/super/i,THIS:/this/i,VAR:/var/i,WHILE:/while/i,_SHEBANG_COMMENT:V.COMMENTS.SHEBANG,_MULTI_LINE_COMMENT:V.COMMENTS.C_STYLE,_SINGLE_LINE_COMMENT:V.COMMENTS.DOUBLE_SLASH,_SPACE:V.SPACE.ALL};var a=Object.keys(U.lexicon).reduce((n,r)=>(n[r]=r,n),{});var b=class extends st{};o(b,"Visitor");var nt=class{constructor(r){this.name=r;this.arity=0}call(r){return new w(this)}toString(){return this.name}};o(nt,"Class");var w=class{constructor(r){this.klass=r;this.fields=new Map}get(r){if(this.fields.has(r.text))return this.fields.get(r.text);throw new E(r,`Undefined property [${r.text}].`)}toString(){return`<<${this.klass.name} instance>>`}};o(w,"Instance");var it=class{constructor(r,t){this.name=r;this.value=t}};o(it,"AssignExpr");var R=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};o(R,"BinaryExpr");var ot=class{constructor(r,t,e){this.callee=r;this.args=t;this.end=e}};o(ot,"CallExpr");var at=class{constructor(r,t){this.params=r;this.block=t}};o(at,"FunctionExpr");var pt=class{constructor(r,t){this.name=r;this.expr=t}};o(pt,"GetExpr");var ct=class{constructor(r){this.inner=r}};o(ct,"GroupExpr");var m=class{constructor(r){this.value=r}toString(){if(this.value instanceof w)return this.value.toString();if(this.value===!0||this.value===!1)return`${this.value}`;if(this.value===void 0)return"nil";if(typeof this.value=="string")return this.value;let[r,t]=this.value;return`${r.toFixed(t)}`}};o(m,"LiteralExpr");var H=class{constructor(r,t,e){this.left=r;this.operator=t;this.right=e}};o(H,"LogicalExpr");var lt=class{constructor(r,t,e,s,i){this.left=r;this.op1=t;this.middle=e;this.op2=s;this.right=i}};o(lt,"TernaryExpr");var ut=class{constructor(r,t){this.operator=r;this.operand=t}};o(ut,"UnaryExpr");var Q=class{constructor(r){this.name=r}};o(Q,"VariableExpr");var W=class extends b{AssignExpr(r){return`(= ${r.name.text} ${this.visit(r.value)})`}BinaryExpr(r){let t=r.operator.text,e=this.visit(r.left),s=this.visit(r.right);return`(${t} ${e} ${s})`}BlockStmt(r){let t=r.statements.map(e=>this.visit(e)).join(`
`);return`(block 
${j(t)}
)`}CallExpr(r){let t=`(call ${this.visit(r.callee)}`;if(!r.args.length)return`${t})`;let e=r.args.map(s=>this.visit(s)).join(" ");return`${t} ${e})`}ClassDecl(r){let t=r.funcs.map(e=>this.visit(e)).join(`
`);return`(class ${r.name.text}
${j(t)}
)`}ExpressionStmt(r){return this.visit(r.expr)}FunctionExpr(r){let t=r.params.map(s=>s.text).join(" "),e=this.visit(r.block);return`(let [${t}] ${e})`}FunctionDecl(r){let t=r.name.text,e=this.visit(r.func);return`(fun ${t} ${e})`}GetExpr(r){return`(. ${JSON.stringify(r.expr)} ${r.name.text})`}GroupExpr(r){return`(group ${this.visit(r.inner)})`}IfStmt(r){let t=this.visit(r.condition),e=this.visit(r.trueStatement);if(!r.falseStatement)return`(if ${t} ${e})`;let s=this.visit(r.falseStatement);return`(if ${t} 
${j(e)} 
${j(s)})`}JumpStmt(r){let t=r.keyword.name,e=this.visit(r.distance||new m([1,0]));return`(${t} ${e})`}LiteralExpr(r){let t=r.toString();return typeof r.value=="string"?JSON.stringify(t):t}LogicalExpr(r){return this.BinaryExpr(r)}PrintStmt(r){return`(print ${this.visit(r.expr)})`}Program(r){let t=r.code.map(e=>this.visit(e)).join(`
`);return`(program 
${j(t)}
)`}ReturnStmt(r){return`(return ${this.visit(r.expr)})`}TernaryExpr(r){let t=this.visit(r.left),e=this.visit(r.middle),s=this.visit(r.right);return`(?: ${t} ${e} ${s})`}UnaryExpr(r){let t=r.operator.text,e=this.visit(r.operand);return`(${t} ${e})`}VariableDecl(r){let t=`(var ${r.name.text}`,e=r.expr?` ${this.visit(r.expr)}`:"";return`${t}${e})`}VariableExpr(r){return`${r.name.text}`}WhileStmt(r){let t=this.visit(r.condition),e=this.visit(r.body);return`(while ${t} 
${j(e)}
)`}};o(W,"Printer");function j(n){let r=new Array(3).fill(" ").join("");return n.replace(/^/mg,r)}o(j,"indent");var ht=class{constructor(r,t){this.name=r;this.funcs=t}};o(ht,"ClassDecl");var mt=class{constructor(r,t){this.name=r;this.func=t}};o(mt,"FunctionDecl");var xt=class{constructor(r,t){this.name=r;this.expr=t}};o(xt,"VariableDecl");var Et=class{constructor(r){this.code=r}};o(Et,"Program");var _=class{constructor(r){this.statements=r}};o(_,"BlockStmt");var q=class{constructor(r){this.expr=r}};o(q,"ExpressionStmt");var z=class{constructor(r,t,e){this.condition=r;this.trueStatement=t;this.falseStatement=e}};o(z,"IfStmt");var ft=class{constructor(r,t){this.keyword=r;this.distance=t}};o(ft,"JumpStmt");var dt=class{constructor(r){this.expr=r}};o(dt,"PrintStmt");var gt=class{constructor(r,t){this.expr=r;this.keyword=t}};o(gt,"ReturnStmt");var K=class{constructor(r,t){this.condition=r;this.body=t}};o(K,"WhileStmt");var vt=class extends rt{parse(){return this._parsed||(this._parsed=this.Program()),this._parsed}toString(){return this._parsed?new W().visit(this._parsed):"un-parsed"}print(t=this._parsed,e="log"){let s=t?new W().visit(t):"()";console[e](s)}Program(){let t=[];for(;!this.atEnd();){let e=this.Declaration();e&&t.push(e)}return new Et(t)}Declaration(){var t,e;try{return((t=this.peek())==null?void 0:t.name)==a.FUN&&((e=this.peek(2))==null?void 0:e.name)==a.IDENTIFIER?(this.match(a.FUN),this.FunDeclaration()):this.match(a.CLASS)?this.ClassDeclaration():this.match(a.VAR)?this.VarDeclaration():this.Statement()}catch(s){if(s instanceof F){this.synchronize();return}else throw s}}ClassDeclaration(){let t=this.consume("IDENTIFIER","Expected identifier");this.consume(a.LEFT_CURL,'Expected "{"');let e=[];for(;;){let s=this.FunDeclaration();if(!s)break;e.push(s)}return this.consume(a.RIGHT_CURL,'Expected "}"'),new ht(t,e)}FunDeclaration(){var t;if(((t=this.peek())==null?void 0:t.name)==a.IDENTIFIER){let e=this.consume("IDENTIFIER","Expected identifier"),s=this.FunctionExpr();return new mt(e,s)}}FunctionExpr(){this.consume(a.LEFT_PAREN,"Expected (");let t=this.Parameters();this.consume(a.RIGHT_PAREN,"Expected )");let e=this.Block();if(!e)throw this.error("Expected {");return new at(t,e)}Parameters(){var e,s;let t=[];if(((e=this.peek())==null?void 0:e.name)!=a.RIGHT_PAREN){t.length>=255&&this.error("Too many params (255 max)");do{let i=this.consume(a.IDENTIFIER,"expected param name");t.push(i)}while(((s=this.peek())==null?void 0:s.name)==a.COMMA)}return t}VarDeclaration(){let t=this.consume("IDENTIFIER","Expected identifier"),e;return this.match(a.EQUAL)&&(e=this.Expression()),this.consume(a.SEMICOLON,"Expected ;"),new xt(t,e)}Statement(){return this.PrintStatement()||this.ReturnStatement()||this.IfStatement()||this.WhileStatement()||this.ForStatement()||this.JumpStatement()||this.Block()||this.ExpressionStatement()}ReturnStatement(){if(this.match(a.RETURN)){let t=this.previous(),e=new m(void 0);return this.match(a.SEMICOLON)||(e=this.Expression(),this.consume(a.SEMICOLON,"Expected ;")),new gt(e,t)}}Block(){var t;if(this.match(a.LEFT_CURL)){let e=[];for(;!this.atEnd()&&((t=this.peek())==null?void 0:t.name)!=a.RIGHT_CURL;){let i=this.Declaration();i&&e.push(i)}let s=new _(e);return this.consume(a.RIGHT_CURL,"Expected }"),s}}JumpStatement(){var t;if(this.match(a.BREAK,a.CONTINUE)){let e=this.previous(),s=new m([1,0]);return((t=this.peek())==null?void 0:t.name)!=a.SEMICOLON&&(s=this.Expression()),this.consume(a.SEMICOLON,"Expected ;"),new ft(e,s)}}IfStatement(){if(this.match(a.IF)){this.consume(a.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(a.RIGHT_PAREN,"Expected )");let e=this.Statement();if(this.match(a.ELSE)){let s=this.Statement();return new z(t,e,s)}else return new z(t,e)}}WhileStatement(){if(this.match(a.WHILE)){this.consume(a.LEFT_PAREN,"Expected (");let t=this.Expression();this.consume(a.RIGHT_PAREN,"Expected )");let e=this.Statement();return new K(t,e)}}ForStatement(){var t,e;if(this.match(a.FOR)){this.consume(a.LEFT_PAREN,"Expected (");let s=this.match(a.VAR)&&this.VarDeclaration()||this.ExpressionStatement()||this.consume(a.SEMICOLON,"Expected ;")&&new m(!0),i=new m(!0);((t=this.peek())==null?void 0:t.name)!=a.SEMICOLON&&(i=this.Expression()),this.consume(a.SEMICOLON,"Expected ;");let c=new m(!0);((e=this.peek())==null?void 0:e.name)!=a.RIGHT_PAREN&&(c=this.Expression()),this.consume(a.RIGHT_PAREN,"Expected )");let p=this.Statement();return new _([s,new K(i,new _([p,new q(c)]))])}}PrintStatement(){if(this.match(a.PRINT)){let t=this.Expression();return this.consume(a.SEMICOLON,"Expected ;"),new dt(t)}}ExpressionStatement(){let t=this.Expression();return this.consume(a.SEMICOLON,"Expected ;"),new q(t)}Expression(){return this.Comma()}Comma(){let t=this.Assignment();for(;this.match(a.COMMA);){let e=this.previous(),s=this.Assignment();t=new R(t,e,s)}return t}Assignment(){let t=this.LogicOr();if(this.match(a.EQUAL)){let e=this.previous(),s=this.Assignment();if(t instanceof Q)return new it(t.name,s);this.error("Invalid assignment target",e)}return t}LogicOr(){let t=this.LogicAnd();for(;this.match(a.OR);){let e=this.previous(),s=this.LogicAnd();t=new H(t,e,s)}return t}LogicAnd(){let t=this.Conditional();for(;this.match(a.AND);){let e=this.previous(),s=this.Conditional();t=new H(t,e,s)}return t}Conditional(){let t=this.Equality();for(;this.match(a.QUESTION);){let e=this.previous(),s=this.Equality();this.consume(a.COLON,"Expected :");let i=this.previous(),c=this.Equality();t=new lt(t,e,s,i,c)}return t}Equality(){let t=this.Comparison();for(;this.match(a.BANG_EQUAL,a.EQUAL_EQUAL);){let e=this.previous(),s=this.Comparison();t=new R(t,e,s)}return t}Comparison(){let t=this.Term();for(;this.match(a.LESS,a.GREATER,a.LESS_EQUAL,a.GREATER_EQUAL);){let e=this.previous(),s=this.Term();t=new R(t,e,s)}return t}Term(){let t=this.Factor();for(;this.match(a.PLUS,a.DASH);){let e=this.previous(),s=this.Factor();t=new R(t,e,s)}return t}Factor(){let t=this.Unary();for(;this.match(a.STAR,a.SLASH);){let e=this.previous(),s=this.Unary();t=new R(t,e,s)}return t}Unary(){for(;this._InvalidUnary(););return this._ValidUnary()}_InvalidUnary(){if(this.match(a.PLUS,a.STAR,a.SLASH))return this.error("Binary operator is missing the left operand",this.previous()),this.previous(),this.Unary()}_ValidUnary(){if(this.match(a.BANG,a.DASH)){let t=this.previous(),e=this.Unary();return new ut(t,e)}return this.Call()}Call(){let t=this.Primary();for(;;)if(this.match(a.LEFT_PAREN)){let e=[];if(!this.check(a.RIGHT_PAREN)){e.length>=255&&this.error("Too many args (255 max)");do e.push(this.Expression());while(this.match(a.COMMA))}let s=this.consume(a.RIGHT_PAREN,"Expected ) after arguments");t=new ot(t,e,s)}else if(this.match(a.DOT)){let e=this.consume(a.IDENTIFIER,"Expected method or attribute name");t=new pt(e,t)}else break;return t}Primary(){if(this.match(a.NUMBER)){let t=this.previous().text,e=parseFloat(t),s=`${t}.`.split(".")[1].length;return new m([e,s])}if(this.match(a.STRING)){let t=this.previous().text,[e,...s]=t.split("");return e===s[s.length-1]&&s.pop(),new m(s.join(""))}if(this.match(a.TRUE))return new m(!0);if(this.match(a.FALSE))return new m(!1);if(this.match(a.NIL))return new m(void 0);if(this.match(a.IDENTIFIER))return new Q(this.previous());if(this.match(a.LEFT_PAREN)){let t=this.Expression();return this.consume(a.RIGHT_PAREN,'Expected ")" after expression'),new ct(t)}if(this.match(a.FUN))return this.FunctionExpr();throw this.error("Expected to find an expression")}synchronize(){var t;for(this.advance();!this.atEnd();){if(this.previous().name=="SEMICOLON")return;switch(((t=this.peek())==null?void 0:t.name)??""){case"CLASS":case"FOR":case"FUN":case"IF":case"PRINT":case"RETURN":case"VAR":case"WHILE":return}this.advance()}}};o(vt,"Parser");var St=class extends b{constructor(t,e){super();this.reporter=t;this.evaluator=e;this.currentFunction=0;this.scopes=[]}beginScope(){this.scopes.unshift({})}endScope(){this.scopes.shift()}declare(t){let e=this.scopes[0];!e||(e[t.text]===0&&this.reporter.error(t,"Variable is already declared"),e[t.text]===1&&this.reporter.error(t,"Variable is already defined"),e[t.text]=0)}define(t){let e=this.scopes[0];!e||(e[t.text]=1)}resolveLocal(t,e){this.scopes.find((s,i)=>s[e.text]?(this.evaluator.resolve(t,i),!0):!1)}resolveFunction(t,e){let s=this.currentFunction;this.currentFunction=e,this.beginScope();for(let i of t.params)this.declare(i),this.define(i);this.visit(t.block),this.endScope(),this.currentFunction=s}AssignExpr(t){this.visit(t.value),this.resolveLocal(t,t.name)}BinaryExpr(t){this.visit(t.left),this.visit(t.right)}BlockStmt(t){this.beginScope();for(let e of t.statements)this.visit(e);this.endScope()}CallExpr(t){this.visit(t.callee);for(let e of t.args)this.visit(e)}ClassDecl(t){this.declare(t.name),this.define(t.name)}ExpressionStmt(t){this.visit(t.expr)}FunctionExpr(t){this.resolveFunction(t,1)}FunctionDecl(t){this.declare(t.name),this.define(t.name),this.resolveFunction(t.func,1)}GetExpr(t){this.visit(t.expr)}GroupExpr(t){this.visit(t.inner)}IfStmt(t){this.visit(t.condition),this.visit(t.trueStatement),t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){this.visit(t.distance)}LiteralExpr(t){}LogicalExpr(t){this.visit(t.left),this.visit(t.right)}PrintStmt(t){this.visit(t.expr)}Program(t){for(let e of t.code)this.visit(e)}ReturnStmt(t){this.currentFunction==0&&this.reporter.error(t.keyword,"No return from top-level allowed"),this.visit(t.expr)}TernaryExpr(t){this.visit(t.left),this.visit(t.middle),this.visit(t.right)}UnaryExpr(t){this.visit(t.operand)}VariableDecl(t){this.declare(t.name),t.expr&&this.visit(t.expr),this.define(t.name)}VariableExpr(t){let e=this.scopes[0];!e||(e[t.name.text]===0&&this.reporter.error(t.name,"Reference to uninitialized variable"),this.resolveLocal(t,t.name))}WhileStmt(t){this.visit(t.condition),this.visit(t.body)}};o(St,"Resolver");var I=class{constructor(r){this.enclosure=r;this.table=new Map}has(r){var t;return this.table.has(r.text)||!!((t=this.enclosure)!=null&&t.has(r))}init(r){this.table.has(r.text)||this.table.set(r.text,void 0)}set(r,t,e=0){var s;if(e>0&&this.enclosure)return this.enclosure.set(r,t,e-1);if(this.table.has(r.text))this.table.set(r.text,t);else if((s=this.enclosure)!=null&&s.has(r))this.enclosure.set(r,t);else throw new E(r,`No such variable: ${r.text}`)}get(r,t=0){var e;if(t>0&&this.enclosure)return this.enclosure.get(r,t-1);if(this.table.has(r.text))return this.table.get(r.text);if((e=this.enclosure)!=null&&e.has(r))return this.enclosure.get(r);throw new E(r,`Undefined variable: ${r.text}`)}};o(I,"Environment");function jt(n){n.globals.init({text:"clock"}),n.globals.set({text:"clock"},{arity:0,call(){return new Date().toLocaleString()}})}o(jt,"registerGlobals");function N(n){return Array.isArray(n)&&n.length==2}o(N,"isNumber");function Mt(n){return typeof n=="string"}o(Mt,"isString");function A(n){return!(n===!1||n===void 0)}o(A,"truthy");var J=class{constructor(r=void 0){this.value=r}};o(J,"ReturnException");var O=class{constructor(r=1){this.distance=r}};o(O,"JumpException");var Y=class extends O{};o(Y,"BreakException");var X=class extends O{};o(X,"ContinueException");function Z(n){return n?!!n.call:!1}o(Z,"isCallable");var yt=class{constructor(r,t){this.arity=r;this.call=t}};o(yt,"Function");var bt=class extends b{constructor(t){super();this.reporter=t;this.globals=new I;this.env=this.globals;this.locals=new Map;jt(this)}resolve(t,e){this.locals.set(t,e)}lookUpVariable(t,e){let s=this.locals.get(e);return s!==void 0?this.env.get(t,s):this.globals.get(t)}AssignExpr(t){let e=this.visit(t.value),s=this.locals.get(t);return s!==void 0?this.env.set(t.name,e,s):this.globals.set(t.name,e),e}BinaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=this.visit(t.right);if(e==a.COMMA)return i;if(e==a.PLUS&&(Mt(s)||Mt(i))){let c=Z(s)?s:new m(s),p=Z(i)?i:new m(i);return`${c}${p}`}if(e==a.EQUAL_EQUAL)return N(s)&&N(i)?s[0]==i[0]:s===i;if(e==a.BANG_EQUAL)return N(s)&&N(i)?s[0]!=i[0]:s!==i;if(!N(s)||!N(i))throw new E(t.operator,"number values expected");if(i[0]==0)throw new E(t.operator,"divide by zero");if(e==a.PLUS)return[s[0]+i[0],Math.max(s[1],i[1])];if(e==a.DASH)return[s[0]-i[0],Math.max(s[1],i[1])];if(e==a.STAR)return[s[0]*i[0],Math.max(s[1],i[1])];if(e==a.SLASH)return[s[0]/i[0],Math.max(s[1],i[1])];if(e==a.GREATER)return s[0]>i[0];if(e==a.GREATER_EQUAL)return s[0]>=i[0];if(e==a.LESS)return s[0]<i[0];if(e==a.LESS_EQUAL)return s[0]<=i[0];throw new E(t.operator,"Unexpected binary expression")}BlockStmt(t){let e=this.env;this.env=new I(e);try{t.statements.map(s=>this.visit(s))}finally{this.env=e}}CallExpr(t){let e=this.visit(t.callee);if(!Z(e))throw new E(t.end,"uncallable target");if(e.arity!=t.args.length)throw new E(t.end,"wrong number of args");return e.call(t.args.map(s=>this.visit(s)))}ClassDecl(t){this.env.init(t.name);let e=new nt(t.name.text);this.env.set(t.name,e)}ExpressionStmt(t){this.visit(t.expr)}FunctionExpr(t){let e=new I(this.env);return new yt(t.params.length,s=>{let i=this.env;this.env=new I(e);try{s.map((c,p)=>{let u=t.params[p];this.env.init(u),this.env.set(u,c)}),this.visit(t.block)}catch(c){if(c instanceof J)return c.value;throw c}finally{this.env=i}})}FunctionDecl(t){let e=this.FunctionExpr(t.func);this.env.init(t.name),this.env.set(t.name,e)}GetExpr(t){let e=this.visit(t.expr);if(e instanceof w)return e.get(t.name);throw new E(t.name,"Only instances have properties")}GroupExpr(t){return this.visit(t.inner)}IfStmt(t){let e=this.visit(t.condition);A(e)?this.visit(t.trueStatement):t.falseStatement&&this.visit(t.falseStatement)}JumpStmt(t){let e=this.visit(t.distance||new m([1,0]));throw N(e)?t.keyword.name==a.BREAK?new Y(e[0]):new X(e[0]):new E(t.keyword,"expected numerical distance")}LiteralExpr(t){return t.value}LogicalExpr(t){let{operator:{name:e}}=t,s=this.visit(t.left),i=A(s);if(e==a.OR&&i||e==a.AND&&!i)return s;let c=this.visit(t.right);return A(c)?c:A(!1)}PrintStmt(t){let e=this.visit(t.expr),s=Z(e)?e:new m(e).toString();console.log(s+"")}Program(t){try{let e=t.code.map(i=>this.visit(i)),s=e[e.length-1];return Z(s)?`${s}`:new m(s).toString()}catch(e){e instanceof E?this.reporter.error(e.token,e.message):this.reporter.error(void 0,e.message)}}ReturnStmt(t){let e=this.visit(t.expr);throw new J(e)}TernaryExpr(t){let{op1:{name:e},op2:{name:s}}=t;if(e==a.QUESTION&&s==a.COLON){let i=this.visit(t.left);return A(i)?this.visit(t.middle):this.visit(t.right)}throw new E(e,"Unexpected ternary expression")}UnaryExpr(t){let{operator:{name:e}}=t,s=this.visit(t.operand);if(e==a.BANG)return!A(s);if(!N(s))throw new E(e,"must negate a number value");if(e==a.DASH)return[-s[0],s[1]];throw new E(e,"Unexpected unary expression")}VariableDecl(t){this.env.init(t.name);let e=t.expr?this.visit(t.expr):void 0;this.env.set(t.name,e)}VariableExpr(t){return this.lookUpVariable(t.name,t)}WhileStmt(t){for(;A(this.visit(t.condition));)try{this.visit(t.body)}catch(e){if(e instanceof O){if(e.distance>1)throw e.distance-=1,e;if(e instanceof X)continue;if(e instanceof Y)break}}}};o(bt,"Interpreter");var Rt=class extends et{constructor(){super(...arguments);this.version=Qt;this.Tokenizer=U;this.Parser=vt;this.Resolver=St;this.Interpreter=bt}};o(Rt,"StoxLang");var f={hideCursor:"\x1B[?25l",showCursor:"\x1B[?25h",ctrlA:"",ctrlC:"",ctrlD:"",ctrlE:"",ctrlK:"\v",up:"\x1B[A",down:"\x1B[B",right:"\x1B[C",left:"\x1B[D",backspace:"\x7F",delete:"\x1B[3~",newline:`
`,return:"\r",reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fgBlack:"\x1B[30m",fgRed:"\x1B[31m",fgGreen:"\x1B[32m",fgYellow:"\x1B[33m",fgBlue:"\x1B[34m",fgMagenta:"\x1B[35m",fgCyan:"\x1B[36m",fgWhite:"\x1B[37m",bgBlack:"\x1B[40m",bgRed:"\x1B[41m",bgGreen:"\x1B[42m",bgYellow:"\x1B[43m",bgBlue:"\x1B[44m",bgMagenta:"\x1B[45m",bgCyan:"\x1B[46m",bgWhite:"\x1B[47m"},Wt=o(n=>!n.match(/[\p{Cc}\p{Cn}\p{Cs}]+/gu),"isPrintable");var Dt=class{constructor(r,t){this.isError=r;this.isContinuation=t}get text(){return this.isError?"\xD7 ":this.isContinuation?"  ":"\xBB "}get markup(){return this.isError?`${f.fgRed}${this.text}${f.reset}`:`${f.dim}${this.text}${f.reset}`}get width(){return 2}};o(Dt,"Prompt");var Ct=class{constructor(){this._text=""}insert(r,t){let[e,s]=[this._text.substring(0,t),this._text.substring(t)];this._text=`${e}${r}${s}`}backspace(r){let[t,e]=[this._text.substring(0,r),this._text.substring(r)],s=t.substring(0,t.length-1);this._text=`${s}${e}`}clear(r){this._text=this._text.substring(0,r)}get text(){return this._text}};o(Ct,"Input");var L=class{constructor(r,t){this.cursor=0;this.prompt=new Dt(r,t),this.input=new Ct}render(){this.cursor=0,process.stdout.moveCursor(this.cursor,1),process.stdout.cursorTo(this.cursor),process.stdout.write(this.prompt.markup),process.stdout.write(this.input.text)}clearTilEnd(){this.input.clear(this.cursor),process.stdout.clearScreenDown()}insert(r){this.input.insert(r,this.cursor),process.stdout.clearLine(1);let t=this.input.text.substring(this.cursor);process.stdout.write(t),this.cursor+=r.length,process.stdout.moveCursor(-(t.length-r.length),0)}backspace(){if(this.cursor===0)return;this.input.backspace(this.cursor),this.cursor-=1,process.stdout.moveCursor(-1,0),process.stdout.clearLine(1);let r=this.input.text.substring(this.cursor);process.stdout.write(r),process.stdout.moveCursor(-r.length,0)}moveRight(r=1){this.cursor!==this.input.text.length&&(this.cursor+=r,process.stdout.moveCursor(r,0))}moveLeft(r=1){this.cursor!==0&&(this.cursor-=r,process.stdout.moveCursor(-r,0))}moveToLineStart(){this.moveLeft(this.cursor)}moveToLineEnd(){this.moveRight(this.input.text.length-this.cursor)}newline(){process.stdout.moveCursor(0,1),process.stdout.cursorTo(0),console.log("")}hideCursor(){process.stdout.write(f.hideCursor)}showCursor(){process.stdout.write(f.showCursor)}};o(L,"Line");var Nt=class{};o(Nt,"IncompleteException");var Ft=class{constructor(){this.commands=[""];this.pos=0}update(r){this.commands[this.pos]=r}save(){this.commands.push(""),this.pos+=1}next(){return this.goto(this.pos+1)}previous(){return this.goto(this.pos-1)}goto(r){return this.pos=Math.max(0,r),this.pos=Math.min(this.commands.length-1,this.pos),this.commands[this.pos]}};o(Ft,"History");var Lt=new Ft;function qt(n,r){let t=[],e=new L(!1,!1);return e.render(),s=>{let i=s.toString(),c=o(()=>{Wt(i)&&e.insert(i)},"inserter"),p=o(()=>{if(e.input.text||e.prompt.isContinuation)try{let g=e.input.text;e.prompt.isContinuation&&(g=[...t,g].join(`
`)),n.run(g),e=new L(!1,!1),Lt.save(),t=[]}catch(g){g instanceof Nt?(t.push(e.input.text),e=new L(e.prompt.isError,!0)):e=new L(!0,e.prompt.isContinuation)}else e=new L(!1,!1);return e},"runner"),u={[f.ctrlA]:()=>e.moveToLineStart(),[f.ctrlC]:()=>{e.newline(),e.moveToLineStart(),e.clearTilEnd(),e.render()},[f.ctrlD]:()=>r(),[f.ctrlE]:()=>e.moveToLineEnd(),[f.ctrlK]:()=>e.clearTilEnd(),[f.up]:()=>{e.moveToLineStart(),e.clearTilEnd(),e.insert(Lt.previous())},[f.down]:()=>{e.moveToLineStart(),e.clearTilEnd(),e.insert(Lt.next())},[f.right]:()=>e.moveRight(),[f.left]:()=>e.moveLeft(),[f.backspace]:()=>e.backspace(),[f.return]:()=>{e.newline(),p(),e.render()},[f.delete]:()=>{e.moveRight(),e.backspace()}};e.hideCursor(),u[i]?u[i]():c(),e.showCursor(),Lt.update(e.input.text.trim())}}o(qt,"lineKeyBinder");var Tt=class{constructor(r){this.lang=r}spashScreen(){console.log("help: ?\u23CE"),console.log("exit: CTRL-d")}async run(){return process.stdin.setRawMode(!0),process.stdin.setEncoding("utf8"),this.spashScreen(),process.stdin.resume(),new Promise(r=>{let t=qt(this.lang,()=>{process.stdin.destroy(),r(void 0)});process.stdin.on("data",e=>{t(e),process.stdin.resume()})})}};o(Tt,"Repl");var kt=class extends Tt{};o(kt,"Repl");process.stdin.pause();$.default.parse([{short:"r",long:"repl",description:"runs the repl"},{short:"t",long:"tokens",description:"prints tokens and exits "},{short:"p",long:"parse",description:"prints parse tree and exits "},{short:"v",long:"version",description:"prints version info and exits "}],[{name:"file"}],!0);var wt=new Rt;$.default.get("version")&&(console.log(`stox-${wt.version}`),process.exit(0));var le=$.default.get("tokens"),ue=$.default.get("parse"),he=le&&"scan"||ue&&"parse"||"eval";wt.options({stage:he});if($.default.get("repl")&&process.stdout.isTTY)new kt(wt).run().finally(()=>process.exit(0));else{process.stdin.resume();let n=$.default.arg("file")??"/dev/stdin",r=zt.default.readFileSync(n).toString();wt.run(n,r),process.exit(wt.errored?1:0)}
//# sourceMappingURL=stox.js.map